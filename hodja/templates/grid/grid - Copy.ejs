
<%
var showInfoRow=false

if(locals.options.show.filter || locals.options.show.pageSize || locals.options.show.pageCount || locals.options.show.pagerButtons)
	showInfoRow=true


%>
<%- programButtons(locals.data.session,locals.data.urlPath) %>
<div class="table-responsive <%- showInfoRow?'mt-1':''%>">
	<div class="table-responsive">
		<!-- info row -->
		<% if(showInfoRow){ %>
		<div class="row m-0 border">
			<div class="col-12 pt-1 px-1">
				<div class="float-left form-inline m-0 p-0 mt-1 mb-1">
					<%- locals.options.show.filter?`<a class="btn btn-secondary btn-sm mr-3" data-toggle="collapse" href="#filterRow" role="button" aria-expanded="false" aria-controls="filterRow" title="Filtre satırını göster/gizle"><i class="fas fa-filter"></i></a>`:``%>
					<%- locals.options.show.pageSize?`${builder.control('grid/pagesize',locals)}`:``%>
					<%- locals.options.show.pageCount?`${builder.control('grid/pageinfo',locals)}`:``%>
				</div>
				<%- locals.options.show.pagerButtons?`<div class="float-right">${builder.control('grid/pagerbuttons',locals)}</div>`:``%>
			</div>
		</div>
		<%}%>
		<!-- ./info row -->

		<!-- table -->
		<table id="grid<%-locals.id%>" class="table table-striped border m-0 <%- locals.options.insideForm?'table-bordered':''%>"  cellspacing="0">
			<%- locals.options.show.header?`${builder.control('grid/header',locals)}`:``%>
			<%- builder.control('grid/body',locals) %>
			<%- locals.options.show.footer?`${builder.control('grid/footer',locals)}`:``%>
		</table>
		<!-- ./table -->

		<!-- info row -->
		<% if(showInfoRow){ %>
		<div class="row m-0 border">
			<div class="col-12 pt-1 px-1">
				<div class="float-left form-inline m-0 p-0 mt-1 mb-1">
					<div class="">
						buraya butonlar geliyor
					</div>
					<%- locals.options.show.pageCount?`${builder.control('grid/pageinfo',locals)}`:``%>
				</div>
				<%- locals.options.show.pagerButtons?`<div class="float-right">${builder.control('grid/pagerbuttons',locals)}</div>`:``%>
			</div>
		</div>
		<%}%>
		<!-- ./info row -->
	</div>
</div>


<script type="text/javascript">
	$(document).ready(()=>{
		gridHelper.init(<%- locals.id %>,<%-JSON.stringify(locals.fields)%>,<%-JSON.stringify(locals.options)%>)
		
		$("#fileUpload").change(function() {
			var reader  = new FileReader()
			var fileIndex=0
			var files=this.files
			var uploadFiles=[]
			reader.addEventListener("load", function(){

				if(reader.result){
					uploadFiles[uploadFiles.length-1].data=reader.result.split('base64,')[1]
				}
				fileIndex++
				runReader()
			})

			function runReader(){
				if(fileIndex>=files.length){
					document.dispatchEvent(new CustomEvent("file-upload-finished", {detail:uploadFiles}))
					return
				}
				var file=files[fileIndex]
				uploadFiles.push({name:file.name,modifiedDate:file.lastModifiedDate,size:file.size,data:''})
				
				reader.readAsDataURL(file)
			}

			runReader()
		})
	})
	var programId=''
	var programType=''

	document.addEventListener('file-upload-finished', function(event) {
		var data={files:event.detail}
		runProgramAjax(data)
	})

	function runProgram(_id,type){
		programId=_id
		programType=type
		if(type=='file-importer'){
			$('#fileUpload').trigger('click')
			return
		}
		var list=[]

		$(".checkSingle").each(function() {
			if(this.checked){
				//var satir=JSON.parse(decodeURIComponent(this.value))
				//list.push({_id:satir._id})
				list.push({_id:this.value})
			}
		})
		if(list.length==0)
			return alertX('Hiç kayıt seçilmemiş')
		var data={list:list}
		runProgramAjax(data)

	}

	function runProgramAjax(data){
		$.ajax({
			url:`/dbapi/programs/run/${programId}`,
			data:data,
			type:'POST',
			dataType: "json",
			success:function(result){
				if(result.success){
					if(typeof result.data=='string'){
						if(programType=='file-exporter'){
							download(`data:application/file;base64,${btoa2(result.data)}`,`export_${(new Date()).yyyymmddhhmmss()}.txt`,'application/file')
							return
						}else if(programType=='connector-exporter'){
							alert(result.data)
						}
					}
					
					window.location.reload()	
				}else{
					alertX(result.error.message,'HATA','danger')
				}
			},
			error:function(err){
				alertX((err.message || err.name || 'Hata oluştu'),'HATA','danger')
			}
		})
	}

</script>