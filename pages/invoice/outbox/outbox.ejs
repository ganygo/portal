<%layout('../../_common/layout')%>
<form action="" method="POST" role="form" name="form1">
	<div class="row m-0 mt-2">
		<div class="col-12 p-0">
			<%- partial('../../_common/date-filter',{includeForm:false,includeFilterButton:false}) %>
			
			<div class="float-left form-inline ml-md-4">
				<label class="text-primary">Senaryo:</label>
				<select class="form-control input-inline input-sm" name="profileId" id="profileId">
					<% docProfileIdList.forEach((e)=>{ %> 
					<option value="<%=e.value%>"<% if(typeof filter.profileId!='undefined') if(filter.profileId==e.value){%>selected<% } %>><%=e.text%></option>
					<% }) %>
				</select>
			</div>
			<div class="float-left form-inline ml-md-2">
				<label class="text-primary">Fatura Türü:</label>
				<select class="form-control input-inline input-sm" name="invoiceTypeCode" id="invoiceTypeCode">
					<% docTypeCodeList.forEach((e)=>{ %> 
					<option value="<%=e.value%>"<% if(typeof filter.invoiceTypeCode!='undefined') if(filter.invoiceTypeCode==e.value){%>selected<% } %>><%=e.text%></option>
					<% }) %>
				</select>
			</div>
			<div class="float-md-right">
				<button type="submit" name="btnFilter" class="btn btn-primary" value="true"><i class="fa fa-filter"></i> Filtrele</button>
			</div>
		</div>
	</div>
</form>

<div class="btn-toolbar mt-2 border p-1 rounded justify-content-start" role="toolbar" aria-label="Toolbar with button groups">
	<div class="btn-group mr-2" role="group" aria-label="">
		<button type="button" class="btn btn-primary" id="btnSendToGib">Gönder</button>
	</div>
	<div class="btn-group mr-2" role="group" aria-label="">
		<button type="button" class="btn btn-info" id="btnSendToArchive">Arşive Kaldır</button>
	</div>
	<div class="btn-group mr-2" role="group" aria-label="">
		<button type="button" class="btn btn-info" id="btnImportFromLocal" title="Local Connector ile iceri al"><i class="fas fa-plug"></i> İçeri Al</button>
	</div>
	<div class="btn-group mr-2" role="group" aria-label="">
		<button type="button" class="btn btn-info" id="btnImportFromFile" title="File Importar kullanarak iceri al"><i class="fas fa-file-import"></i> Dosyadan İçeri Al</button>
		<input type="file" name="fileUpload" id="fileUpload" style="visibility:hidden;" accept="*.csv,*.txt" multiple>
	</div>
	
</div>

<% if(typeof message!='undefined') { %>
<% if(message!='') { %>
<div class="row">
	<div class="col-md-12">
		<div class="alert alert-danger" role="alert">
			<%=message %>
		</div>
	</div>
</div>
<% } %>
<% } %>

<%- partial('../../_common/grid2',{
	fields:[
		{name:'invoiceNo',text:'Fat.No',type:'label', filterField:'invoiceNo', filter:true,orderable:true},
		{name:'issueDate',text:'Fat. Tarihi',type:'label', orderable:true},
		{name:'partyName',text:'Unvan',type:'label', filter:true, orderable:true},
		{name:'amount',text:'Tutar',type:'label'},
		{name:'tax',text:'Vergi',type:'label' },
		{name:'currency',text:'Döviz',type:'lookup',filter:true, filterField:'documentCurrencyCode', lookupList:currencyList,textField:'text', valueField:'value', dontUseLookup:true },
		{name:'invoiceStatus',text:'Durumu', width:'100px',type:'lookup',filter:true, lookupList:docStatusTypes, textField:'text', valueField:'value', orderable:false , dontUseLookup:true}
	],
	caption:'Giden Faturalar',
	addNewButton:true,
	viewButton:false,
	editButton:true,
	deleteButton:true,
	selection:true,
	customButtons:[
		{href:'javascript:popupCenter("/e-invoice/outbox/view/{_id}?db=' + db + '&sid=' + sid + '","Ön izleme","900","600");', text:'Goruntule',icon:'fas fa-search-plus'},
		{href:'/e-invoice/outbox/pdf/{_id}?db=' + db + '&sid=' + sid, text:'Pdf',icon:'fas fa-file-pdf'}
	],
	deleteUrl:'/dbapi/e-invoice/invoice/{_id}?db='+db+'&sid=' + sid
}) 
%>

<script type="text/javascript">
	$(document).ready(function(){
		
		$("#btnImportFromFile").click(function() {
			$("#fileUpload").trigger('click'); 
	    });

		$("#fileUpload").change(function() {
			
			var reader  = new FileReader();
			var fileIndex=0;
			var files=this.files;
			var willBeSentFiles=[];
			reader.addEventListener("load", function(){
				
				if(reader.result){
					willBeSentFiles[willBeSentFiles.length-1].base64Data=reader.result.split('base64,')[1];
				}
				fileIndex++;
				runReader();
			});

			function runReader(){
				if(fileIndex>=files.length){
					sendFileImport(willBeSentFiles);
					return;
				}
				var file=files[fileIndex];
				willBeSentFiles.push({name:file.name,modifiedDate:file.lastModifiedDate,size:file.size,base64Data:''});
				reader.readAsDataURL(file);
			}
			
			runReader();
	    });

		function sendFileImport(files){
			if(!confirm(files.length + ' adet dosya iceri alinacaktir. Onayliyor musunuz?')) return;
			$.ajax({
				url:'/dbapi/e-invoice/importOutboxInvoice?db=<%=db%>&sid=<%=sid%>',
				data:{fileImporter:'', files:files},
				type:'POST',
				success:function(result){
					if(result.success){
						//alert('Aktarim basladi.');
						window.location.reload();
					}else{
						alert(result.error.message);
					}
				}
			});
		}

		$('#btnImportFromLocal').click(function(){
			$.ajax({
				url:'/dbapi/e-invoice/transfer/import?db=<%=db%>&sid=<%=sid%>',
				data:{},
				type:'POST',
				success:function(result){
					if(result.success){
						alert('Islem gorev yoneticisine eklendi. Birazdan tamamlanir.');
						window.location.reload();
					}else{

					   alert(result.error.code + '\n' + result.error.message);
				   }
			   }
		   });
			
		});
		
		
		$('#btnSendToGib').click(function(){
			var data={list:[]};
			$(".checkSingle").each(function() {
				if(this.checked){
					var satir=JSON.parse(decodeURIComponent(this.value));
					if(satir.doc.invoiceStatus=='Draft' || satir.doc.invoiceStatus=='Error'){
						data.list.push({_id:satir._id, ID:satir.doc.ID});
					}
					
				}
			});
			if(data.list.length==0)  return alert('Kayit secilmemis!\nDurum: Taslak + Hata');
			if(!confirm(data.list.length + ' adet fatura GIB e gonderilecektir. Onayliyor musunuz?')) return;
			$.ajax({
				url:'/dbapi/e-invoice/sendToGib?db=<%=db%>&sid=<%=sid%>',
				data:data,
				type:'POST',
				success:function(result){
					if(result.success){
						//alert('Aktarim basladi.');
						window.location.reload();
					}else{
						alert(result.error.code + '\n' + result.error.message);
					}
				}
			});
			
		});
	});

	function showErrors(_id){
		var url='<%=urlPath%>/errors/'+ _id + '?db=<%=db%>&sid=<%=sid%>';
		popupCenter(url,'Goster','900','600');
	}
	
</script>