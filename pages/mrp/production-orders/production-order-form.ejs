<%
	headerButtons='';
    formName='form1';

    headerButtons +='<button type="button" class="btn btn-primary" title="Kaydet" onclick="formKaydet()"><i class="fas fa-save"></i></button>';
    
    headerButtons +='<a href="javascript:goBack();" class="btn btn-dark ml-2" title="Vazgeç"><i class="fas fa-reply"></i></a>';
%>

<script type="text/javascript">
    var headerButtons=document.getElementById('headerButtons');
    if(headerButtons){
      headerButtons.innerHTML='<%- headerButtons %>';
    }
   
    var db='<%=db%>';
    var sid='<%=sid%>';
    var _id='<%=(form._id || '')%>';
    var q=getAllUrlParams();
    var doc=clone(dbType.productionOrderType);

    doc.issueDate=(new Date()).yyyymmdd();
    doc.issueTime=(new Date()).hhmm();

    <% 
        if(typeof form._id!='undefined'){
        if((form._id || '')!=''){ 
    %>
    doc=JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(form))%>'));
    
    <%  }
    } %>

    
</script>

<form action="" method="POST" role="form" name="form1" id="form1">
    <% if(typeof message!='undefined'){ if(message!=''){ %>
    <div class="row">
        <div class="col-lg-12 col-md-12">
            <div class="alert alert-danger" role="alert">
                <%=message %>
            </div>
        </div>
    </div>
    <% } } %>
    <ul class="nav nav-tabs form-tabs" role="tablist">
        <li class="nav-item">
            <a class="nav-link active" href="#tab1" role="tab" data-toggle="tab" id="IDtab1" aria-controls="tab1" aria-selected="true">
                <i class="fas fa-file-alt"></i> Bilgiler
            </a>
        </li>
        <li class="nav-item">
            <a class="nav-link" href="#tab2" role="tab" data-toggle="tab" id="IDtab2" aria-controls="tab2" aria-selected="false">
                <i class="fas fa-table"></i> Üretim Prosesi
            </a>
        </li>
    </ul>
    <div class="tab-content p-1" style="min-height: 70vh;overflow: auto;">
        <!-- IDtab1 -->
        <div class="tab-pane show active" id="tab1" role="tabpanel" aria-labelledby="IDtab1">
            <div class="card">
                <div class="card-header p-1">
                    <div class="float-left bold text-primary">Genel Bilgiler</div>
                    <div class="float-right bold text-primary form-inline">
                        <label>XXX:</label>
                        
                    </div>
                    
                </div>
                <div class="card-body p-1">
                    <div class="row">
                        <div class="form-group col-md-3">
                            <label for="" class="m-0"><%=title%> No</label>
                            <input type="text" class="form-control" name="productionId" placeholder="Boş ise otomatik verilir" autocomplete="off" value="<%=form.productionId%>">
                        </div>
                        <div class="form-group col-md-2">
                            <label for="" class="m-0">Tarih</label>
                            <div class="input-group date">
                                <input type="text" name="issueDate" id="issueDate" class="form-control" value="">
                                <div class="input-group-addon">
                                    <i class="fa fa-calendar fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="" class="m-0">Saat</label>
                            <div class="input-group" id="issueTime1">
                                <input type="text" name="issueTime" id="issueTime" class="form-control" value="">
                                <div class="input-group-addon">
                                    <i class="fa fa-clock fa-2x"></i>
                                </div>
                            </div>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="" class="m-0">Türü</label>
                            <select name="productionTypeCode" id="productionTypeCode" class="form-control" onchange="productionTypeCode_change()">
                                <% productionTypeCodeList.forEach(function(e){ %>
                                <option value="<%=e.value%>" <% if(e.value==form.productionTypeCode){%>selected<%} %> ><%=e.text%></option>
                                <% }); %>
                            </select>
                        </div>
                    </div>
					<div class="row">
                    	<div class="form-group col-md-4">
                            <label for="" class="m-0">Uretilecek Mamul</label>
                            <input type="text" class="form-control" id="main-item-name" autocomplete="off" placeholder="" value="" readonly="true">
                        </div>
                        <div class="form-group col-md-3">
                            <label for="" class="m-0">Reçete</label>
                            <select id="main-recipe" class="form-control">
                            	
                            </select>
                        </div>
                        <div class="form-group col-md-2">
                            <label for="" class="m-0">Planlanan Miktar</label>
                            <input type="number" class="form-control" id="plannedQuantity-quantity" autocomplete="off" value="0" readonly="true">
                        </div>
                        <div class="form-group col-md-2">
                            <a href="javascript:receteUygula()" class="btn btn-primary mt-3"><i class="fas fa-fill-drip" title="Reçeteyi uygula"></i> Uygula</a>
                        </div>
                    </div>
                </div>
            </div>
            <div id="forCustomerPanel" class="card mt-2">
                <div class="card-header p-1">
                    <div class="float-left bold text-primary">Sipariş(ler)</div>
                    <div class="float-right bold text-primary">
                        <a href="javascript:modalSalesOrders()" class="btn btn-primary btn-sm"><i class="fas fa-plus-square"></i> Sipariş</a>
                    </div>
                </div>
                <div class="card-body p-1" style="overflow: auto;">
                    <table id="gridOrderLineReference" class="table form-table table-bordered table-striped m-0"  cellspacing="0">
		                <thead>
		                    <tr class="text-nowrap">
		                        <th width="100" class="">Sip No</th>
		                        <th width="100" class="">Tarih</th>
		                        <th width="" class="">Müşteri</th>
		                        <th width="" class="">Mamül</th>
		                        <th width="100" class="text-right">Sip.Miktar</th>
		                        <th width="100" class="text-right">Sevkedilen</th>
		                        <th width="100" class="text-right">Ürt.Miktar</th>
		                        <th width="50" class="text-center">#</th>
		                    </tr>
		                </thead>
		                <tbody id="gridOrderLineReferenceTBody">
		                    
		                </tbody>
		            </table>

                </div>
            </div>
            <div id="forDepoPanel" class="card mt-2" style="display:none;">
                <div class="card-header p-1">
                    <div class="bold text-primary">Depo için üretilecek</div>
                </div>
                <div class="card-body p-1" style="overflow: auto;">
                    <div class="row">
                    	<div class="form-group col-md-4">
                            <label for="" class="m-0">Mamul</label>
                            <input type="text" class="form-control" id="item-name" autocomplete="off" placeholder="" value="">
                            <input type="hidden" class="form-control" id="item-id" autocomplete="off" value="">
                        </div>
                        <div class="form-group col-md-2">
                            <label for="" class="m-0">Miktar</label>
                            <input type="number" class="form-control" id="for-inventory-quantity" autocomplete="off" value="0" onchange="calculatePlannedQuantity()">
                        </div>
                    </div>

                </div>
            </div>
            
        </div>

        <!-- IDtab2 -->
        <div class="tab-pane" id="tab2" role="tabpanel" aria-labelledby="IDtab2">
            <%- partial('../../_common/recipe.ejs',{recipeFormType:'production-orders'}) %>
        </div>
    </div>
</form>
<div class="modal" id="salesOrdersModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="salesOrdersModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header p-2 ">
                <label class="modal-title" id="salesOrdersModalLabel">Üretilecek Sipariş(ler)i seç</label>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-2" style="overflow: auto;">
                
                <table id="gridSalesOrders" class="table form-table table-bordered table-striped m-0"  cellspacing="0">
	                <thead>
	                    <tr class="text-nowrap">
	                        <th width="30" class=""><input type="checkbox" class="mt-1" value="true" name="selectAll" id="selectAll"></th>
	                        <th width="100" class="">Sip No</th>
	                        <th width="100" class="">Tarih</th>
	                        <th width="" class="">Müşteri</th>
	                        <th width="" class="">Mamül</th>
	                        <th width="100" class="text-right">Miktar</th>
	                        
	                    </tr>
	                </thead>
	                <tbody id="gridSalesOrdersLineGrid">
	                    
	                </tbody>
	            </table>
                
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Vazgeç</button>
                <a id="salesOrdersModalSaveButton" class="btn btn-primary" href="javascript:okSalesOrders()">Tamam</a>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">
	

	function modalSalesOrders(){
		$("#gridSalesOrdersLineGrid tr").remove();
    	
    	var q=getAllUrlParams();
    	$.ajax({
            url:'/dbapi/production-orders/salesOrders?db=' + q.db + '&sid=' + q.sid,
            type:'GET',
            dataType: 'json',
            success: function(result) {
                if(result.success){
                	var lineGrid=document.getElementById('gridSalesOrdersLineGrid');
					result.data.docs.forEach((sip,index)=>{
				        var newRow=lineGrid.insertRow(lineGrid.rows.length);
				        // newRow.classList.add('text-nowrap');
				        newRow.insertCell(0).innerHTML='<input type="checkbox" class="sipRow" id="sipRow[' + index + ']" name="sipRow[' + index + ']" value="' + encodeURIComponent(JSON.stringify(sip)) + '">';
				        newRow.insertCell(1).innerHTML=sip.ID.value;
				        newRow.insertCell(2).innerHTML=sip.issueDate.value;
				        newRow.insertCell(3).innerHTML=sip.buyerCustomerParty.party.partyName.name.value;
				        newRow.insertCell(4).innerHTML=sip.orderLine.item.name.value;
				        var cell5=newRow.insertCell(5);
				        cell5.classList.add('text-right');
				        cell5.innerHTML=Number(sip.producedRemaining).formatDecimal();
				        
				    });
                    $('#salesOrdersModal').modal('show');
                }
            },
            error:function(err){
                console.log('err:',err);
            }
        });
	}

	function okSalesOrders(){
		var list=[];
		var bFarkliUrunVar=false;

		$(".sipRow").each(function() {
			if(this.checked){
				var sip=JSON.parse(decodeURIComponent(this.value));
				
				//farkli urun kontrolu item._id uzerinden yapilacak
				list.forEach(function(e){
					//if(e.orderLine.item._id)
					if(e.orderLine.item._id!=sip.orderLine.item._id){
						bFarkliUrunVar=true;
						return;
					}
				})
				if(bFarkliUrunVar) return;
				list.push(sip);
				
				
			}
		});
		if(bFarkliUrunVar) return alert('Uretim emrine ayni urunden olan siparisleri ekleyebilirsiniz.');
		if(list.length==0)  return alert('Kayit secilmemis!');
		// if(!confirm(list.length + ' adet siparis icin uretim emri verilecektir. Onayliyor musunuz?')) return;

		list.forEach(function(e){
			var obj={
                lineId:e.orderLine.ID,
                item:e.orderLine.item,
                orderedQuantity:e.orderLine.orderedQuantity,

                // producedQuantity:e.orderLine.producedQuantity,
                producedQuantity:{value:e.producedRemaining, attr:{unitCode:e.orderLine.orderedQuantity.attr.unitCode}},
                deliveredQuantity:e.orderLine.deliveredQuantity,

                orderReference:{
                    order:e.sip_id,
                    ID:e.ID,
                    issueDate:e.issueDate,
                    orderTypeCode:e.orderTypeCode,
                    salesOrderId:e.salesOrderId,
                    buyerCustomerParty:{
                        party:e.buyerCustomerParty.party,
                        deliveryContact:e.buyerCustomerParty.deliveryContact,
                        accountingContact:e.buyerCustomerParty.accountingContact,
                        buyerContact:e.buyerCustomerParty.buyerContact
                    }
                }
            }
            var bFound=false;
            doc.orderLineReference.forEach(function(e2){
            	if(e.ID.value==e2.orderReference.ID.value && e.orderLine.ID.value==e2.lineId.value){
            		bFound=true;
            		return;
            	}
            })
            var bAyniUrun=true;
            doc.orderLineReference.forEach(function(e2){
            	// urun karsilastirimlasi item._id alanindan yapilacak qwerty
            	if(e.orderLine.item._id!=e2.item._id){
            		bAyniUrun=false;
            		return;
            	}
            })
            if(bFound==false && bAyniUrun==true) {
            	doc.orderLineReference.push(obj);
            	if(doc.orderLineReference.length==1){
            		doc.item=doc.orderLineReference[0].item._id;
            		loadMainItemAndRecipe();
            	}
            }
		})
		
		loadOrderLineReference();
		calculatePlannedQuantity();
		$('#salesOrdersModal').modal('hide');
		
	}

	

	function loadOrderLineReference(){
		$("#gridOrderLineReferenceTBody tr").remove();
		var lineGrid=document.getElementById('gridOrderLineReferenceTBody');
		doc.orderLineReference.forEach((sip,index)=>{
	        var newRow=lineGrid.insertRow(lineGrid.rows.length);
	        // newRow.classList.add('text-nowrap');
	        newRow.insertCell(0).innerHTML=sip.orderReference.ID.value + '.' + sip.lineId.value;
	        newRow.insertCell(1).innerHTML=sip.orderReference.issueDate.value;
	        newRow.insertCell(2).innerHTML=sip.orderReference.buyerCustomerParty.party.partyName.name.value;
	        newRow.insertCell(3).innerHTML=sip.item.name.value;
	        var cell4=newRow.insertCell(4);
	        cell4.classList.add('text-right');
	        cell4.innerHTML=Number(sip.orderedQuantity.value).formatDecimal();

	        var cell5=newRow.insertCell(5);
	        cell5.classList.add('text-right');
	        cell5.innerHTML=Number(sip.deliveredQuantity.value).formatDecimal();

	        var cell6=newRow.insertCell(6);
	        cell6.classList.add('text-right');
	        cell6.innerHTML='<input type="number" name="order_producedQuantity[' + index + ']" class="form-control" value="' + sip.producedQuantity.value + '" onchange="calculatePlannedQuantity()" >';

	        var cell7=newRow.insertCell(7);
	        cell7.classList.add('text-center');
	        cell7.innerHTML='<a href="javascript:removeOrderLineReference(' + index + ');" class="btn btn-danger btn-sm fas fa-trash-alt ml-1" title="Sil"></a>';
	        
	    });

	    if(doc.orderLineReference.length>0){
	    	//$('#main-item-name').val(doc.orderLineReference[0].item.name.value);
	    	doc.item=doc.orderLineReference[0].item._id;
	    }
	}

	function removeOrderLineReference(index){
		if(!confirm('Satir:' + (index+1).toString() + '  cikarilacaktir. Onayliyor musunuz?')) return;
		doc.orderLineReference.splice(index,1);
		loadOrderLineReference();
		calculatePlannedQuantity();
	}

	function loadMainItemAndRecipe(){
		$('#main-item-name').val('');
		$('#main-recipe option').remove();

		if((doc.item || '')=='') return;
		$.ajax({
	        url:'/dbapi/items/' + doc.item + '?&db=' + q.db + '&sid=' + q.sid,
	        type:'GET',
	        dataType: 'json',
	        success: function(result) {
	                if(result.success){
	                    $('#main-item-name').val(result.data.name.value);
	                    $.ajax({
					        url:'/dbapi/recipes?item=' + doc.item + '&db=' + q.db + '&sid=' + q.sid,
					        type:'GET',
					        dataType: 'json',
					        success: function(result) {
					                if(result.success){
					                    if(result.data.docs){
					                    	var receteler = document.getElementById("main-recipe");
					                    	result.data.docs.forEach(function(e){
					                    		var c = document.createElement("option");
												c.text = e.name;
												if(e.revision>1) c.text +=' [rev:' + e.revision + ']';
												c.value=e._id;
												receteler.options.add(c, receteler.options.length);
  				                    		});
  				                    		
					                    }
					                }
					            },
					        error:function(err){
					            console.error('err recipes:',err);
					        }
					    });
	                }
	            },
	        error:function(err){
	            console.error('err items:',err);
	        }
	    });
	}

	function productionTypeCode_change(){
		doc.productionTypeCode=$('#productionTypeCode').val();
		//loadMainItemAndRecipe();
		calculatePlannedQuantity();
	}

	function calculatePlannedQuantity(){
		switch(doc.productionTypeCode){
			case 'DEPO':
			doc.plannedQuantity=Number($('#for-inventory-quantity').val());
			$('#plannedQuantity-quantity').val(doc.plannedQuantity)
			break;
			case 'MUSTERI':
			doc.plannedQuantity=0;
			doc.orderLineReference.forEach(function(e,index){
				doc.plannedQuantity+=Number($('input[name="order_producedQuantity[' + index +']"]').val());
			})
			$('#plannedQuantity-quantity').val(doc.plannedQuantity);
			break;
		}
	}
    function loadForm(){
		$('#issueDate').val(doc.issueDate);
		$('#issueTime').val(doc.issueTime);

		if(doc.productionTypeCode!='') $('#productionTypeCode').val(doc.productionTypeCode);

		loadOrderLineReference();
	}
	
	loadForm();

	

	function receteUygula(){
		doc.sourceRecipe=$('#main-recipe').val() || '';
		console.log('doc.item:',doc.item);
		console.log('doc.sourceRecipe:',doc.sourceRecipe);
		console.log('doc.plannedQuantity:',doc.plannedQuantity);
		if((doc.item || '')=='') return alert('Urun secilmemis.');
		if((doc.sourceRecipe || '')=='') return alert('Recete secilmemis.');
		if(doc.plannedQuantity<=0) return alert('Planlanan miktar sifir dan buyuk olmalidir.');
		$.ajax({
	        url:'/dbapi/recipes/' + doc.sourceRecipe + '?db=' + q.db + '&sid=' + q.sid,
	        type:'GET',
	        dataType: 'json',
	        success: function(result) {
	                if(result.success){
	                    var recete=result.data;
	                    var oran=0;
	                    if(recete.totalQuantity>0) oran=doc.plannedQuantity/recete.totalQuantity;
	                    if(oran==0) return alert('Recete orani "0" olamaz. Recete miktarlarini kontrol ediniz.');
	                    doc.description=recete.description;
	                    doc.process=[];
	                    doc.materialSummary=[];
	                    doc.outputSummary=[];
	                    doc.qualityControl=[];
	                    recete.process.forEach(function(e){
	                    	var obj=JSON.parse(JSON.stringify(e));
	                    	obj.input.forEach(function(e2){
	                    		e2.quantity=e2.quantity*oran;
	                    	})
	                    	obj.output.forEach(function(e2){
	                    		e2.quantity=e2.quantity*oran;
	                    	})
	                    	doc.process.push(obj);
	                    });

	                    recete.materialSummary.forEach(function(e){
	                    	var obj=JSON.parse(JSON.stringify(e));
	                    	obj.quantity=obj.quantity * oran;
	                    	doc.materialSummary.push(obj);
	                    });

        				recete.outputSummary.forEach(function(e){
	                    	var obj=JSON.parse(JSON.stringify(e));
	                    	obj.quantity=obj.quantity * oran;
	                    	doc.outputSummary.push(obj);
	                    })
        				
        				doc.qualityControl=JSON.parse(JSON.stringify(recete.qualityControl));
        
        				console.log('doc:',doc);
        				reloadRecipe();
	                }
	            },
	        error:function(err){
	            console.error('err recipes:',err);
	        }
	    });
	}



    $(document).ready(function(){

        $('select[name="productionTypeCode"]').change(function(){
            switch($('select[name="productionTypeCode"]').val()){
	        	case 'DEPO':
	        		$('#forDepoPanel').show();
	        		$('#forCustomerPanel').hide();
	                doc.item=$("#item-id").val();
	        	break;
	        	case 'MUSTERI':
	        		$('#forDepoPanel').hide();
	        		$('#forCustomerPanel').show();
	        		loadOrderLineReference();
	        	break;
	        }

	        loadMainItemAndRecipe();
	        calculatePlannedQuantity();
        });

        $('.input-group.date').datepicker({
            format: 'yyyy-mm-dd',
            language: "tr",
            orientation: "bottom auto",
            // todayBtn: "linked",
            autoclose: true,
            todayHighlight: true,
            clearBtn: true

            // startDate: -4,
            // endDate: +8,
        });
        $('#issueTime1').timepicker({
            format: 'HH:mm:ss',
            language: "tr",
            orientation: "bottom auto",
            // todayBtn: "linked",
            autoclose: true,
            //todayHighlight: true,
            clearBtn: true

            // startDate: -4,
            // endDate: +8,
        });

        

	    $('#item-name').autocomplete({
	        source:function(request,response){
	            $.ajax({
	                url:'/dbapi/items?itemType=product&name=' +  encodeURIComponent(request.term) + '&db=' + q.db + '&sid=' + q.sid,
	                type:'GET',
	                dataType: 'json',
	                success: function(result) {
	                        if(result.success){
	                            var dizi=[];
	                            for(var i=0;i<result.data.docs.length;i++){
	                                var item=result.data.docs[i];
	                                
	                                dizi.push({name:item.name.value, label:(getItemTypeName(item.itemType) + ' - ' + item.name.value),value:item._id});
	                            }
	                            if(dizi.length>0){
	                            	$('#cbNewItemPanel').hide();
	                            }else{
	                            	$('#cbNewItemPanel').show();
	                            }
	                            response(dizi);
	                        }
	                    },
	                error:function(err){
	                    console.error('err:',err);
	                }
	            });
	        },
	        select: function (event, ui) {
	                $("#item-name").val(ui.item.name); 
	                $("#item-id").val(ui.item.value);
	                doc.item=ui.item.value;
	                //$('#main-item-name').val(ui.item.name);
	                loadMainItemAndRecipe();
	                return false;
	            }
	    });
    });
</script>