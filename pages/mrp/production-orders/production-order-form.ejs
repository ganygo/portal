<%
headerButtons='';
formName='form1';

if(func=='approvement'){
	headerButtons +='<button type="button" class="btn btn-primary btn-form-header m-1" title="Onayla" onclick="approve()"><i class="fas fa-check-square"></i> Onayla</button>';
	headerButtons +='<button type="button" class="btn btn-danger btn-form-header m-1" title="Reddet" onclick="decline()"><i class="fas fa-window-close"></i> Reddet</button>';
}else if(func=='start'){
	headerButtons +='<button type="button" class="btn btn-primary btn-form-header m-1" title="Üretim başlasın" onclick="start()"><i class="fas fa-play-circle"></i> Üretim başlasın</button>';
	headerButtons +='<button type="button" class="btn btn-danger btn-form-header m-1" title="Taslak hale geri çevir" onclick="makeDraftBack()"><i class="fas fa-window-close"></i> Taslak hale geri çevir</button>';
}else if(func=='complete'){
	headerButtons +='<button type="button" class="btn btn-primary btn-form-header m-1" title="Üretimi tamamla" onclick="complete()"><i class="fas fa-check-square"></i> Üretimi tamamla</button>';
	headerButtons +='<button type="button" class="btn btn-danger btn-form-header m-1" title="Taslak hale geri çevir" onclick="makeDraftBack()"><i class="fas fa-window-close"></i> Taslak hale geri çevir</button>';
}else{
	headerButtons +='<button type="button" class="btn btn-primary btn-form-header" title="Kaydet" onclick="formKaydet()"><i class="fas fa-save"></i></button>';
}
headerButtons +='<a href="javascript:goBack();" class="btn btn-dark btn-form-header m-1" title="Vazgeç"><i class="fas fa-reply"></i></a>';
%>

<script type="text/javascript">
	var headerButtons=document.getElementById('headerButtons');
	if(headerButtons){
		headerButtons.innerHTML='<%- headerButtons %>';
	}

	var db='<%=db%>';
	var sid='<%=sid%>';
	var _id='<%=(form._id || '')%>';
	var q=getAllUrlParams();
	var doc=clone(dbType.productionOrderType);

	doc=Object.assign({},doc,JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(form))%>')));

	if((doc._id || '')==''){
		doc.issueDate=(new Date()).yyyymmdd();
		doc.issueTime=(new Date()).hhmm();
	}
	console.log('doc.status:',doc.status);

</script>

<ul class="nav nav-tabs" role="tablist">
	<li class="nav-item">
		<a class="nav-link active" href="#formTab1" role="tab" data-toggle="tab" id="IDformTab1" aria-controls="formTab1" aria-selected="true">
			Üretim emri
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link" href="#formTab2" role="tab" data-toggle="tab" id="IDformTab2" aria-controls="formTab2" aria-selected="false">
			Hammadde/Malzeme Hareket
		</a>
	</li>
	<li class="nav-item">
		<a class="nav-link" href="#formTab3" role="tab" data-toggle="tab" id="IDformTab3" aria-controls="formTab3" aria-selected="false">
			Mamul Stok
		</a>
	</li>
</ul>
<div class="tab-content" style="min-height: 70vh;overflow: auto;">
	<div class="tab-pane show active" id="formTab1" role="tabpanel" aria-labelledby="IDformTab1">
		<% if(typeof message!='undefined'){ if(message!=''){ %>
		<div class="row">
			<div class="col-lg-12 col-md-12">
				<div class="alert alert-danger" role="alert">
					<%=message %>
				</div>
			</div>
		</div>
		<% } } %>

		<% if(func=='start' || func=='complete'){ %>
		<div class="card">
			<div class="card-header p-1">
				<div class="float-left bold text-primary">Yazdırılacak evraklar</div>
				<div class="float-right bold text-primary form-inline">
					<label></label>

				</div>

			</div>
			<div class="card-body p-2">
				<% printDesignList.forEach((e)=>{ %>
				<div class="float-left m-2">
					<a class="btn invoice-satis p-2 bold" href="javascript:popupCenter('/general/print?path=/production-orders/<%=form._id%>&sid=<%=sid%>&designId=<%=e._id%>','Yazd%C4%B1r','900','600');"><i class="fas fa-print"></i> <%=e.name%></a>
				</div>
				<% }) %>
			</div>
		</div>
		<% } %>
		<div class="card">
			<div class="card-header p-1">
				<div class="float-left bold text-primary">Genel Bilgiler</div>
				<div class="float-right bold text-primary form-inline">
					<label>XXX:<%=mode%> || <%=func%></label>

				</div>

			</div>
			<div class="card-body p-1">
				<div class="row">
					<div class="form-group col-md-3">
						<label for="" class="m-0"><%=title%> No</label>
						<input type="text" class="form-control" name="productionId" id="productionId" placeholder="Boş ise otomatik verilir" autocomplete="off" value="<%=form.productionId%>" <% if(mode=='view'){%>readonly="true"<%}%>>
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0">Tarih</label>
						<input type="date" name="issueDate" id="issueDate" class="form-control"  required autocomplete="off" value="" title="Evrak tarihi" <% if(mode=='view'){%>readonly="true"<%}%>>
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0">Saat</label>
						<input type="text" name="issueTime" id="issueTime" class="form-control" required autocomplete="off" value="" title="Evrak saati" <% if(mode=='view'){%>readonly="true"<%}%>>
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0">Türü</label>
						<select name="productionTypeCode" id="productionTypeCode" class="form-control" <% if(mode=='view'){%>disabled<%}%>>
							<% productionTypeCodeList.forEach(function(e){ %>
							<option value="<%=e.value%>" <% if(e.value==form.productionTypeCode){%>selected<%} %> ><%=e.text%></option>
							<% }); %>
						</select>
					</div>
				</div>
				<div class="row">
					<div class="form-group col-md-4">
						<label for="" class="m-0">Uretilecek Mamul</label>
						<input type="text" class="form-control" id="production-item-name" autocomplete="off" placeholder="" value="" readonly="true">
						<input type="hidden" class="form-control" id="production-item-id" autocomplete="off" value="">
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0">Reçete</label>
						<select id="main-recipe" class="form-control" <% if(mode=='view'){%>disabled<%}%>>
						</select>
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0">Üretilecek Miktar</label>
						<input type="number" class="form-control" id="plannedQuantity-quantity" autocomplete="off" value="0" readonly="true" onchange="calculatePlannedQuantity()">
					</div>
					<div class="form-group col-md-2">
						<label for="" class="m-0"><i class="fas fa-user-friends"></i> Gerekli İnsan</label>
						<select class="form-control" name="staffCount" id="staffCount" <% if(mode=='view'){%>disabled<%}%>>
							<option value="0">-- Sıfır --</option>
							<option value="0.20">%20</option>
							<option value="0.25">%25</option>
							<option value="0.50">%50</option>
							<option value="1">%100</option>
							<option value="1.5">%150</option>
							<option value="2">%200</option>
							<option disabled="disabled">---</option>
							<option value="3">3 Kişi</option>
							<option value="4">4 Kişi</option>
							<option value="5">5 Kişi</option>
							<option value="10">10 Kişi</option>
							<option value="20">20 Kişi</option>
						</select>
					</div>
					<% if(mode!='view'){%>
					<div class="form-group col-md-2 text-right">
						<a href="javascript:receteUygula()" class="btn btn-primary mt-md-4"><i class="fas fa-fill-drip" title="Reçeteyi uygula" ></i> Uygula</a>
					</div>
					<%}%>
				</div>
				<div class="row">
					<div class="col-md-4">
						<div class="form-group">
							<label for="" class="m-0">Planlama Başlangıç</label>
							<div class="form-inline">
								<div class="input-group <% if(mode!='view'){%>date<%}%>" style="width: 120px;">
									<input type="text" name="plannedPeriod[startDate]" id="plannedPeriod-startDate" class="form-control" value="" title="Planlama başlangıç tarihi" <% if(mode=='view'){%>readonly="true"<%}%>>
									<div class="input-group-addon">
										<i class="fa fa-calendar fa-2x"></i>
									</div>
								</div>
								<select class="form-control ml-3" name="plannedPeriod[startTimeHour]" id="plannedPeriod-startTimeHour" <% if(mode=='view'){%>disabled<%}%>>
									<% for(var i=0;i<=23;i++){ %>
									<option value="<%=i.n2()%>"><%=i.n2()%></option>
									<% } %>
								</select>
								<select class="form-control" name="plannedPeriod[startTimeMinute]" id="plannedPeriod-startTimeMinute" <% if(mode=='view'){%>disabled<%}%>>
									<% for(var i=0;i<=3;i++){ %>
									<option value="<%=(i*15).n2()%>"><%=(i*15).n2()%></option>
									<% } %>
								</select>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="form-group">
							<label for="" class="m-0">Bitiş</label>
							<div class="form-inline">
								<div class="input-group <% if(mode!='view'){%>date<%}%>" style="width: 120px;">
									<input type="text" name="plannedPeriod[endDate]" id="plannedPeriod-endDate" class="form-control" value="" title="Planlama başlangıç tarihi" <% if(mode=='view'){%>readonly="true"<%}%>>
									<div class="input-group-addon">
										<i class="fa fa-calendar fa-2x"></i>
									</div>
								</div>
								<select class="form-control ml-3" name="plannedPeriod[endTimeHour]" id="plannedPeriod-endTimeHour" <% if(mode=='view'){%>disabled<%}%>>
									<% for(var i=0;i<=23;i++){ %>
									<option value="<%=i.n2()%>"><%=i.n2()%></option>
									<% } %>
								</select>
								<select class="form-control" name="plannedPeriod[endTimeMinute]" id="plannedPeriod-endTimeMinute" <% if(mode=='view'){%>disabled<%}%>>
									<% for(var i=0;i<=3;i++){ %>
									<option value="<%=(i*15).n2()%>"><%=(i*15).n2()%></option>
									<% } %>
								</select>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div id="forCustomerPanel" class="card mt-2">
			<div class="card-header p-1">
				<div class="float-left bold text-primary">Sipariş(ler)</div>
				<% if(mode!='view'){%>
				<div class="float-right bold text-primary">
					<a href="javascript:modalSalesOrders()" class="btn btn-primary btn-sm"><i class="fas fa-plus-square"></i> Sipariş</a>
				</div>
				<% }%>
			</div>
			<div class="card-body p-1" style="overflow: auto;">
				<table id="gridOrderLineReference" class="table form-table table-bordered table-striped m-0"  cellspacing="0">
					<thead>
						<tr class="text-nowrap">
							<th width="100" class="">Sip No</th>
							<th width="100" class="">Tarih</th>
							<th width="" class="">Müşteri</th>
							<th width="" class="">Mamül</th>
							<th width="100" class="text-right">Sip.Miktar</th>
							<th width="100" class="text-right">Sevkedilen</th>
							<th width="100" class="text-right">Ürt.Miktar</th>
							<th width="50" class="text-center">#</th>
						</tr>
					</thead>
					<tbody id="gridOrderLineReferenceTBody">

					</tbody>
				</table>

			</div>
		</div>

		<%- partial('../../_common/forms/recipe.ejs',{recipeFormType:'production-orders'}) %>

		<div class="card mt-2">
			<div class="card-header p-1">Palet/Ambalaj/Kutu/Koli</div>
			<div class="card-body p-1">
				<div class="row m-0 p-0">

					<div class="col-md-3 p-0 m-0 form-group">
						<select class="form-control" id="choosePackingOption" name="choosePackingOption" onchange="choosePackingOptionChanged()" <% if(mode=='view'){%>disabled<%}%>></select>
					</div>
					<div class="w-100"></div>

					<div class="col-md-3 p-0 m-0 form-group">
						<label class="m-0">Palet</label>
						<input type="text" class="form-control" name="palletType" id="palletType" value="" readonly="true" />
					</div>
					<div class="col-md-3 p-0 m-0 form-group">
						<label class="m-0">Ambalaj</label>
						<input type="text" class="form-control" name="packingType" id="packingType" value="" readonly="true" />
					</div>
					<div class="col-md-2 p-0 m-0 form-group">
						<label class="m-0">Koli içi miktar</label>
						<input type="number" class="form-control" name="quantityInPacking" id="quantityInPacking" value="0" readonly="true" />
					</div>
					<div class="col-md-2 p-0 m-0 form-group">
						<label class="m-0">Palet İstif Sıra</label>
						<input type="number" class="form-control" name="palletRowCount" id="palletRowCount" value="0" readonly="true" />
					</div>
					<div class="col-md-2 p-0 m-0 form-group">
						<label class="m-0">Sıradaki Koli sayısı</label>
						<input type="number" class="form-control" name="packingCountInRow" id="packingCountInRow" value="0"  readonly="true" />
					</div>
					<div class="col-md-3 p-0 m-0 form-group">
						<label class="m-0">Ambalaj 2</label>
						<input type="text" class="form-control" name="packingType2" id="packingType2" value="" readonly="true" />
					</div>
					<div class="col-md-3 p-0 m-0 form-group">
						<label class="m-0">Ambalaj 3</label>
						<input type="text" class="form-control" name="packingType3" id="packingType3" value="" readonly="true" />
					</div>
					<div class="col-md-2 p-0 m-0 form-group">
						<label class="m-0 bold">Toplam Palet</label>
						<input type="number" class="form-control bold" name="totalPallet" id="totalPallet" value="0" readonly="true" />
					</div>
					<div class="col-md-2 p-0 m-0 form-group">
						<label class="m-0 bold">Toplam Koli/kutu</label>
						<input type="number" class="form-control bold" name="totalPacking" id="totalPacking" value="0" readonly="true" />
					</div>
				</div>
				<div class="row m-0 p-0">
					<div class="col-md-12">
						<div id="aciklama1"></div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<div class="tab-pane" id="formTab2" role="tabpane2" aria-labelledby="IDformTab2">
		<div class="row m-0 p-0 mt-2">
			<div class="col-md-4 m-0 p-0 pr-md-2">
				<div class="card">
					<div class="card-header p-1">
						<div class="float-left bold text-primary">Üretim için gereken malzemeler</div>
					</div>
					<div class="card-body p-1">
						<table id="gridProOrderMaterials" class="table form-table table-bordered table-striped m-0"  cellspacing="0">
							<thead>
								<tr class="text-nowrap">
									<th width="40" class="">No</th>
									<th class="">Stok Karti</th>
									<th class="text-right">Miktar</th>
									<th class="text-right">Kalan</th>
								</tr>
							</thead>
							<tbody id="lineGridProOrder">
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="col m-0 p-0">
				<div class="card">
					<div class="card-header p-1">
						<div class="float-left bold text-primary">Üretime Çıkış Fişleri</div>
						<div class="float-right bold text-primary">
							<a class="btn btn-sm btn-primary" href="/inventory/inventory-fiches/addnew?sid=<%=sid%>&docTypeCode=URETIMECIKIS&productionOrderId=<%=form._id%>" title="Uretim recetesine gore hammadde ve malzeme cikisi"><i class="fas fa-boxes"></i> Yeni Üretime Çıkış Fişi</a>
						</div>
					</div>
					<div class="card-body p-1">
						<table  class="table form-table table-bordered table-striped m-0"  cellspacing="0">
							<thead>
								<tr class="text-nowrap">
									<th width="100" class="">Fiş No</th>
									<th width="40" class="">No</th>
									<th width="60%" class="">Stok Karti</th>
									<th class="text-right" style="min-width:100px;">Miktar</th>
									<th>Brm</th>

									<th width="80" class="text-center">#</th>
								</tr>
							</thead>
							<tbody id="lineGridUretimeCikis">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>

	</div>
	<div class="tab-pane" id="formTab3" role="tabpane3" aria-labelledby="IDformTab3">
		<div class="row m-0 p-0 mt-2">
			<div class="col-md-4 m-0 p-0 pr-md-2">
				<div class="card">
					<div class="card-header p-1">
						<div class="float-left bold text-primary">Ürün ve Yan ürünler</div>
					</div>
					<div class="card-body p-1">
						<table class="table form-table table-bordered table-striped m-0"  cellspacing="0">
							<thead>
								<tr class="text-nowrap">
									<th width="40" class="">No</th>
									<th class="">Stok Karti</th>
									<th class="text-right">Miktar</th>
									<th class="text-right">Kalan</th>
								</tr>
							</thead>
							<tbody id="lineGridProOrderMamul">
							</tbody>
						</table>
					</div>
				</div>
			</div>
			<div class="col m-0 p-0">
				<div class="card">
					<div class="card-header p-1">
						<div class="float-left bold text-primary">Üretimden Giriş Fişleri</div>
						<div class="float-right bold text-primary">
							<a class="btn btn-sm btn-primary" href="/inventory/inventory-fiches/addnew?sid=<%=sid%>&docTypeCode=URETIMDENGIRIS&productionOrderId=<%=form._id%>" title="Üretilmiş mamul/yarı mamullerin stoğa alınması"><i class="fas fa-box"></i> Yeni Üretimden Giriş Fişi</a>
						</div>
					</div>
					<div class="card-body p-1">
						<table  class="table form-table table-bordered table-striped m-0"  cellspacing="0">
							<thead>
								<tr class="text-nowrap">
									<th width="100" class="">Fiş No</th>
									<th width="40" class="">No</th>
									<th width="60%" class="">Stok Karti</th>
									<th class="text-right" style="min-width:100px;">Miktar</th>
									<th>Brm</th>

									<th width="80" class="text-center">#</th>
								</tr>
							</thead>
							<tbody id="lineGridUretimdenGiris">
							</tbody>
						</table>
					</div>
				</div>
			</div>
		</div>
	</div>     
</div>

<div class="modal" id="salesOrdersModal" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="salesOrdersModalLabel" aria-hidden="true">
	<div class="modal-dialog modal-lg modal-scrollable modal-dialog-centered" role="document">
		<div class="modal-content">
			<div class="modal-header p-2 ">
				<label class="modal-title" id="salesOrdersModalLabel">Üretilecek Sipariş(ler)i seç</label>
				<button class="close" type="button" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body p-2" style="overflow: auto;">

				<table id="gridSalesOrders" class="table form-table table-bordered table-striped m-0"  cellspacing="0">
					<thead>
						<tr class="text-nowrap">
							<th width="30" class=""><input type="checkbox" class="mt-1" value="true" name="selectAll" id="selectAll"></th>
							<th width="100" class="">Sip No</th>
							<th width="100" class="">Tarih</th>
							<th width="" class="">Müşteri</th>
							<th width="" class="">Mamül</th>
							<th width="100" class="text-right">Miktar</th>

						</tr>
					</thead>
					<tbody id="gridSalesOrdersLineGrid">

					</tbody>
				</table>

			</div>

			<div class="modal-footer">
				<button class="btn btn-secondary" type="button" data-dismiss="modal">Vazgeç</button>
				<a id="salesOrdersModalSaveButton" class="btn btn-primary" href="javascript:okSalesOrders()">Tamam</a>
			</div>
		</div>
	</div>
</div>

<script type="text/javascript">

	function modalSalesOrders(){
		$("#gridSalesOrdersLineGrid tr").remove();

		var q=getAllUrlParams();
		$.ajax({
			url:`/dbapi/production-orders/salesOrders?sid=${q.sid}`,
			type:'GET',
			dataType: 'json',
			success: function(result) {
				if(result.success){
					var lineGrid=document.getElementById('gridSalesOrdersLineGrid');
					result.data.docs.forEach((sip,index)=>{
						var newRow=lineGrid.insertRow(lineGrid.rows.length);
				        // newRow.classList.add('text-nowrap');
				        newRow.insertCell(0).innerHTML='<input type="checkbox" class="sipRow" id="sipRow[' + index + ']" name="sipRow[' + index + ']" value="' + encodeURIComponent(JSON.stringify(sip)) + '">';
				        newRow.insertCell(1).innerHTML=sip.ID.value;
				        newRow.insertCell(2).innerHTML=sip.issueDate.value;
				        newRow.insertCell(3).innerHTML=sip.buyerCustomerParty.party.partyName.name.value;
				        newRow.insertCell(4).innerHTML=sip.orderLine.item.name.value;
				        var cell5=newRow.insertCell(5);
				        cell5.classList.add('text-right');
				        cell5.innerHTML=Number(sip.producedRemaining).formatDecimal();
				        
				      });
					$('#salesOrdersModal').modal('show');
				}
			},
			error:function(err){
				console.log('err:',err);
			}
		});
	}

	function okSalesOrders(){
		var list=[];
		var bFarkliUrunVar=false;

		$(".sipRow").each(function() {
			if(this.checked){
				var sip=JSON.parse(decodeURIComponent(this.value));
				
				//farkli urun kontrolu item._id uzerinden yapilacak
				list.forEach(function(e){
					//if(e.orderLine.item._id)
					if(e.orderLine.item._id!=sip.orderLine.item._id){
						bFarkliUrunVar=true;
						return;
					}
				})
				if(bFarkliUrunVar) return;
				list.push(sip);
				
				
			}
		});
		if(bFarkliUrunVar) return alert('Uretim emrine ayni urunden olan siparisleri ekleyebilirsiniz.');
		if(list.length==0)  return alert('Kayit secilmemis!');

		list.forEach(function(e){
			
			var obj={
				lineId:e.orderLine.ID,
				item:e.orderLine.item,
				orderedQuantity:e.orderLine.orderedQuantity,
				producedQuantity:{
					value:e.producedRemaining, 
					attr:{
						unitCode:e.orderLine.orderedQuantity.attr.unitCode
					}
				},
				deliveredQuantity:e.orderLine.deliveredQuantity,
				orderReference:{
					order:e.sip_id,
					ID:e.ID,
					issueDate:e.issueDate,
					orderTypeCode:e.orderTypeCode,
					salesOrderId:e.salesOrderId,
					buyerCustomerParty:{
						party:e.buyerCustomerParty.party,
						deliveryContact:e.buyerCustomerParty.deliveryContact,
						accountingContact:e.buyerCustomerParty.accountingContact,
						buyerContact:e.buyerCustomerParty.buyerContact
					}
				}
			}

			var bFound=false;
			doc.orderLineReference.forEach(function(e2){
				if(e.ID.value==e2.orderReference.ID.value && e.orderLine.ID.value==e2.lineId.value){
					bFound=true;
					return;
				}
			});

			var bAyniUrun=true;
			doc.orderLineReference.forEach(function(e2){
				if(e.orderLine.item._id!=e2.item._id){
					bAyniUrun=false;
					return;
				}
			});

			if(bFound==false && bAyniUrun==true) {
				doc.orderLineReference.push(obj);
				if(doc.orderLineReference.length==1){
					doc.item=doc.orderLineReference[0].item._id;
					loadMainItemAndRecipe();
				}
			}
		})
		
		loadOrderLineReference();
		calculatePlannedQuantity();
		$('#salesOrdersModal').modal('hide');
		
	}

	

	function loadOrderLineReference(){
		$("#gridOrderLineReferenceTBody tr").remove();
		var lineGrid=document.getElementById('gridOrderLineReferenceTBody');
		doc.orderLineReference.forEach((sip,index)=>{
			var newRow=lineGrid.insertRow(lineGrid.rows.length);
	        // newRow.classList.add('text-nowrap');
	        newRow.insertCell(0).innerHTML=sip.orderReference.ID.value + '.' + sip.lineId.value;
	        newRow.insertCell(1).innerHTML=sip.orderReference.issueDate.value;
	        newRow.insertCell(2).innerHTML=sip.orderReference.buyerCustomerParty.party.partyName.name.value;
	        newRow.insertCell(3).innerHTML=sip.item.name.value;
	        var cell4=newRow.insertCell(4);
	        cell4.classList.add('text-right');
	        cell4.innerHTML=Number(sip.orderedQuantity.value).formatDecimal();

	        var cell5=newRow.insertCell(5);
	        cell5.classList.add('text-right');
	        cell5.innerHTML=Number(sip.deliveredQuantity.value).formatDecimal();

	        var cell6=newRow.insertCell(6);
	        cell6.classList.add('text-right');
	        cell6.innerHTML='<input type="number" name="order_producedQuantity[' + index + ']" class="form-control" value="' + sip.producedQuantity.value + '" onchange="calculatePlannedQuantity()" <% if(mode=='view'){%>readonly="true"<%}%> >';

	        var cell7=newRow.insertCell(7);
	        cell7.classList.add('text-center');
	        <% if(mode!='view'){ %>
	        	cell7.innerHTML='<a href="javascript:removeOrderLineReference(' + index + ');" class="btn btn-danger btn-sm fas fa-trash-alt ml-1" title="Sil"></a>';
	        	<% } else {%>
	        		cell7.innerHTML='';
	        		<%}%>
	        	});

		if(doc.orderLineReference.length>0){

			doc.item=doc.orderLineReference[0].item._id;
		}
	}

	function removeOrderLineReference(index){
		if(!confirm('Satir:' + (index+1).toString() + '  cikarilacaktir. Onayliyor musunuz?')) return;
		doc.orderLineReference.splice(index,1);
		loadOrderLineReference();
		calculatePlannedQuantity();
	}

	var sourceRecipeDoc;
	var itemDoc;

	function loadMainItemAndRecipe(callback){
		$('#production-item-name').val('');
		$('#main-recipe option').remove();

		if((doc.item || '')=='') return;
		$.ajax({
			url:`/dbapi/items/${doc.item}?sid=${q.sid}`,
			type:'GET',
			dataType: 'json',
			success: function(result) {
				if(result.success){
					itemDoc=result.data;
					load_packingTypes();
					$('#production-item-name').val(result.data.name.value);
					$.ajax({
						url:`/dbapi/recipes?item=${doc.item}&sid=${q.sid}`,
						type:'GET',
						dataType: 'json',
						success: function(result) {
							if(result.success){
								if(result.data.docs){
									var receteler = document.getElementById("main-recipe");
									result.data.docs.forEach(function(e){
										var c = document.createElement("option");
										c.text = e.name;
										if(e.revision>1) c.text +=' [rev:' + e.revision + ']';
										c.value=e._id;
										if((doc.sourceRecipe || '')!=''){
											if(doc.sourceRecipe==e._id){
												c.selected=true;
												doc.recipeName=e.name;
												doc.recipeRevision=e.revision;
												sourceRecipeDoc=clone(e);
											}
										}
										receteler.options.add(c, receteler.options.length);
									});

									if(callback!=undefined) callback(null)
								}
						}
					},
					error:function(err){
						if(callback!=undefined) callback('hata:(loadMainItemAndRecipe)');
						console.error('err recipes:',err);
					}
				});
				}
			},
			error:function(err){
				console.error('err items:',err);
			}
		});
	}


	function load_packingTypes(){
		if(itemDoc==undefined) return;

		$('#choosePackingOption option').remove();

		var packingOptions = document.getElementById("choosePackingOption");
		if(itemDoc.packingOptions){
			itemDoc.packingOptions.forEach(function(e){
				var c = document.createElement("option");
				c.text='';
				if(e.palletType){
					c.text += e.palletType.name + ' - ';
				}
				if(e.packingType){
					c.text += e.packingType.name + ' - ';
				}
				if(e.packingType2){
					c.text += e.packingType2.name + ' - ';
				}
				if(e.packingType3){
					c.text += e.packingType3.name;
				}

				c.value=encodeURIComponent(JSON.stringify(e)); 
				if(doc.packingOption){
					var palletType=e.palletType?e.palletType._id.toString():'';
					var packingType=e.packingType?e.packingType._id.toString():'';
					var packingType2=e.packingType2?e.packingType2._id.toString():'';
					var packingType3=e.packingType3?e.packingType3._id.toString():'';

					var doc_palletType=doc.packingOption.palletType?doc.packingOption.palletType._id.toString():'';
					var doc_packingType=doc.packingOption.packingType?doc.packingOption.packingType._id.toString():'';
					var doc_packingType2=doc.packingOption.packingType2?doc.packingOption.packingType2._id.toString():'';
					var doc_packingType3=doc.packingOption.packingType3?doc.packingOption.packingType3._id.toString():'';

					if(palletType==doc_palletType && packingType==doc_packingType && packingType2==doc_packingType2 && packingType3==doc_packingType3){
						c.selected=true;
					}
				}

				packingOptions.options.add(c, packingOptions.options.length);
			});
		}
		choosePackingOptionChanged();

	}

	function choosePackingOptionChanged(){
		if($('#choosePackingOption').val()=='') return;
		var obj=JSON.parse(decodeURIComponent($('#choosePackingOption').val()));
		if(!obj) return;
		console.log('choosePackingOptionChanged() obj:',obj);
		if((obj.palletType || '')!='') 
			$('#palletType').val(obj.palletType.name);
		else
			$('#palletType').val('');

		if((obj.packingType || '')!='') 
			$('#packingType').val(obj.packingType.name);
		else
			$('#packingType').val('');

		if((obj.packingType2 || '')!='')             
			$('#packingType2').val(obj.packingType2.name);
		else
			$('#packingType2').val('');

		if((obj.packingType3 || '')!='')
			$('#packingType3').val(obj.packingType3.name);
		else
			$('#packingType3').val('');


		$('#quantityInPacking').val((obj.quantityInPacking || 0));
		$('#palletRowCount').val((obj.palletRowCount || 0));
		$('#packingCountInRow').val((obj.packingCountInRow || 0));
	}

	function paketPaletHesapla(){
		var quantityInPacking=Number($('#quantityInPacking').val());
		var palletRowCount=Number($('#palletRowCount').val());
		var packingCountInRow=Number($('#packingCountInRow').val());
		var plannedQuantity=Number($('#plannedQuantity-quantity').val());

		var totalPacking=0;
		var totalPallet=0;

		if(quantityInPacking>0) totalPacking=Math.ceil(plannedQuantity/quantityInPacking);

		if(packingCountInRow*palletRowCount>0) totalPallet=Math.ceil(totalPacking/(packingCountInRow*palletRowCount));

		$('#totalPacking').val(totalPacking);
		$('#totalPallet').val(totalPallet);
	}




	var calculating=false;

	function calculatePlannedQuantity(){
		if(calculating) return;
		calculating=true;
		switch(doc.productionTypeCode){
			case 'DEPO':
			doc.plannedQuantity=Number($('#plannedQuantity-quantity').val());
			//$('#plannedQuantity-quantity').val(doc.plannedQuantity)
			break;
			case 'MUSTERI':
			doc.plannedQuantity=0;
			doc.orderLineReference.forEach(function(e,index){
				doc.plannedQuantity+=Number($('input[name="order_producedQuantity[' + index +']"]').val());
			})
			$('#plannedQuantity-quantity').val(doc.plannedQuantity);
			break;
		}
		calculating=false;
	}



	function loadUretimeCikanMalzemeler(){
		var lineGrid=document.getElementById('lineGridUretimeCikis');
		while(lineGrid.rows.length>1){
			lineGrid.deleteRow(0);
		}

		var uretimeCikmisMalzemeToplamlari=[];

		if(Array.isArray(doc.inventory_fiches)){
			doc.inventory_fiches.forEach(function(fiche){
				if(fiche.docTypeCode=='URETIMECIKIS'){
					fiche.docLine.forEach(function(line){
						var newRow=lineGrid.insertRow(lineGrid.rows.length);
						var cell0=newRow.insertCell(0);
						cell0.innerHTML=fiche.docId;

						var cell1=newRow.insertCell(1);
						cell1.classList.add('text-right');
						cell1.innerHTML=line.sequence;

						var cell2=newRow.insertCell(2);
						cell2.innerHTML=line.item==undefined?'':line.item.name.value + (line.item.description.value!=''?' - ' + line.item.description.value:'');
						cell2.innerHTML+=line.pallet?'<br>Plt:' + line.pallet.name:'';
						cell2.innerHTML+=line.lotNo!=''?'<br>Lot:' + line.lotNo:'';
						cell2.innerHTML+=line.serialNo!=''?'<br>Sn:' + line.serialNo:'';
						cell2.innerHTML+=line.color?'<br>Renk:' + line.color.name:'';
						cell2.innerHTML+=line.pattern?'<br>Desen:' + line.pattern.name:'';
						cell2.innerHTML+=line.size?'<br>Beden:' + line.size.name:'';

						var cell3=newRow.insertCell(3);
						cell3.classList.add('text-right');
						cell3.innerHTML=Number(line.quantity).formatQuantity();

						var cell4=newRow.insertCell(4);
						cell4.innerHTML=getUnitCodeText(line.unitCode);

						var cell5=newRow.insertCell(5);
						cell5.innerHTML='<a class="btn btn-primary fas fa-edit" href="/inventory/inventory-fiches/edit/' + fiche._id + '?db=' + q.db + '&sid=' + q.sid + '" title="Stok Fişini değiştir/aç"></a>';
						cell5.classList.add('text-center');

						var bFound=false;
						uretimeCikmisMalzemeToplamlari.forEach(function(e){
							var id1=e.item!=undefined?e.item._id:'';
							var id2=line.item!=undefined?line.item._id:'';
							var color1=e.color!=undefined?e.color._id:'';
							var color2=line.color!=undefined?line.color._id:'';
							var pattern1=e.pattern!=undefined?e.pattern._id:'';
							var pattern2=line.pattern!=undefined?line.pattern._id:'';
							var size1=e.size!=undefined?e.size._id:'';
							var size2=line.size!=undefined?line.size._id:'';

							if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
								e.quantity+=line.quantity;
								bFound=true;
								return;
							}
						});
						if(!bFound){
							var m={
								item:line.item,
								color:line.color,
								pattern:line.pattern,
								size:line.size,
								quantity:line.quantity
							}
							uretimeCikmisMalzemeToplamlari.push(m);
						}
					})
				}
			});
		}

        // uretim emrinde gereken hammadde ve malzemeler
        var uretimIcinGerekliMalzemeler=[];
        doc.process.forEach(function(process){
        	process.input.forEach(function(processInput){
        		var bFound=false;
        		uretimIcinGerekliMalzemeler.forEach(function(e){
        			var id1=e.item!=undefined?e.item._id:'';
        			var id2=processInput.item!=undefined?processInput.item._id:'';
        			var color1=e.color!=undefined?e.color._id:'';
        			var color2=processInput.color!=undefined?processInput.color._id:'';
        			var pattern1=e.pattern!=undefined?e.pattern._id:'';
        			var pattern2=processInput.pattern!=undefined?processInput.pattern._id:'';
        			var size1=e.size!=undefined?e.size._id:'';
        			var size2=processInput.size!=undefined?processInput.size._id:'';

        			if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
        				e.quantity+=processInput.quantity;
        				bFound=true;
        				return;
        			}
        		});
        		if(!bFound){
        			var m={
        				item:processInput.item,
        				color:processInput.color,
        				pattern:processInput.pattern,
        				size:processInput.size,
        				quantity:processInput.quantity
        			}
        			uretimIcinGerekliMalzemeler.push(m);
        		}
        	})

        })
        var lineGridProOrder=document.getElementById('lineGridProOrder');
        while(lineGridProOrder.rows.length>1){
        	lineGridProOrder.deleteRow(0);
        }

        uretimIcinGerekliMalzemeler.forEach(function(e,index){
        	var kalan=0;
        	var toplam=0;
        	uretimeCikmisMalzemeToplamlari.forEach(function(e2){
        		var id1=e.item!=undefined?e.item._id:'';
        		var id2=e2.item!=undefined?e2.item._id:'';
        		var color1=e.color!=undefined?e.color._id:'';
        		var color2=e2.color!=undefined?e2.color._id:'';
        		var pattern1=e.pattern!=undefined?e.pattern._id:'';
        		var pattern2=e2.pattern!=undefined?e2.pattern._id:'';
        		var size1=e.size!=undefined?e.size._id:'';
        		var size2=e2.size!=undefined?e2.size._id:'';

        		if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
        			toplam +=e2.quantity;
        		}

        	})
        	kalan=e.quantity-toplam;

        	var newRow=lineGridProOrder.insertRow(lineGridProOrder.rows.length);
        	if(kalan<0){
        		newRow.classList.add('text-danger');
        		newRow.classList.add('bold');

        	}
        	newRow.insertCell(0).innerHTML=(index+1).n2();
        	var cell1 = newRow.insertCell(1);
        	cell1.innerHTML=e.item==undefined?'':e.item.name.value + (e.item.description.value!=''?' - ' + e.item.description.value:'');
        	cell1.innerHTML+=e.pallet?'<br>Plt:' + e.pallet.name:'';
        	cell1.innerHTML+=e.color?'<br>Renk:' + e.color.name:'';
        	cell1.innerHTML+=e.pattern?'<br>Desen:' + e.pattern.name:'';
        	cell1.innerHTML+=e.size?'<br>Beden:' + e.size.name:'';

        	var cell2=newRow.insertCell(2);
        	cell2.classList.add('text-right');
        	cell2.innerHTML=Number(e.quantity).formatDecimal();
        	var cell3=newRow.insertCell(3);
        	cell3.classList.add('text-right');
        	if(kalan>=0){
        		cell3.innerHTML=Number(kalan).formatDecimal();
        	}else{
        		cell3.innerHTML='(' + Number(kalan).formatDecimal() + ')';
        	}
        });
        // console.log('uretimeCikmisMalzemeToplamlari:',uretimeCikmisMalzemeToplamlari);
        // console.log('uretimIcinGerekliMalzemeler:',uretimIcinGerekliMalzemeler);
      }

      function loadUretimdenGirenMamuller(){
      	var lineGrid=document.getElementById('lineGridUretimdenGiris');
      	while(lineGrid.rows.length>1){
      		lineGrid.deleteRow(0);
      	}

      	var uretimdenStogaGirmisMamuller=[];

      	if(Array.isArray(doc.inventory_fiches)){
      		doc.inventory_fiches.forEach(function(fiche){
      			if(fiche.docTypeCode=='URETIMDENGIRIS'){
      				fiche.docLine.forEach(function(line){
      					var newRow=lineGrid.insertRow(lineGrid.rows.length);
      					var cell0=newRow.insertCell(0);
      					cell0.innerHTML=fiche.docId;

      					var cell1=newRow.insertCell(1);
      					cell1.classList.add('text-right');
      					cell1.innerHTML=line.sequence;

      					var cell2=newRow.insertCell(2);
      					cell2.innerHTML=line.item==undefined?'':line.item.name.value + (line.item.description.value!=''?' - ' + line.item.description.value:'');
      					cell2.innerHTML+=line.pallet?'<br>Plt:' + line.pallet.name:'';
      					cell2.innerHTML+=line.lotNo!=''?'<br>Lot:' + line.lotNo:'';
      					cell2.innerHTML+=line.serialNo!=''?'<br>Sn:' + line.serialNo:'';
      					cell2.innerHTML+=line.color?'<br>Renk:' + line.color.name:'';
      					cell2.innerHTML+=line.pattern?'<br>Desen:' + line.pattern.name:'';
      					cell2.innerHTML+=line.size?'<br>Beden:' + line.size.name:'';

      					var cell3=newRow.insertCell(3);
      					cell3.classList.add('text-right');
      					cell3.innerHTML=Number(line.quantity).formatQuantity();

      					var cell4=newRow.insertCell(4);
      					cell4.innerHTML=getUnitCodeText(line.unitCode);

      					var cell5=newRow.insertCell(5);
      					cell5.innerHTML='<a class="btn btn-primary fas fa-edit" href="/inventory/inventory-fiches/edit/' + fiche._id + '?db=' + q.db + '&sid=' + q.sid + '" title="Stok Fişini değiştir/aç"></a>';
      					cell5.classList.add('text-center');

      					var bFound=false;
      					uretimdenStogaGirmisMamuller.forEach(function(e){
      						var id1=e.item!=undefined?e.item._id:'';
      						var id2=line.item!=undefined?line.item._id:'';
      						var color1=e.color!=undefined?e.color._id:'';
      						var color2=line.color!=undefined?line.color._id:'';
      						var pattern1=e.pattern!=undefined?e.pattern._id:'';
      						var pattern2=line.pattern!=undefined?line.pattern._id:'';
      						var size1=e.size!=undefined?e.size._id:'';
      						var size2=line.size!=undefined?line.size._id:'';

      						if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
      							e.quantity+=line.quantity;
      							bFound=true;
      							return;
      						}
      					});
      					if(!bFound){
      						var m={
      							item:line.item,
      							color:line.color,
      							pattern:line.pattern,
      							size:line.size,
      							quantity:line.quantity
      						}
      						uretimdenStogaGirmisMamuller.push(m);
      					}
      				})
      			}
      		});
      	}

        // uretim sonucu cikmasi gereken mamul ve yarimamuller
        var uretimEmrindekiMamuller=[];
        var m1={
        	item:itemDoc,
        	color:undefined,
        	pattern:undefined,
        	size:undefined,
        	quantity:doc.plannedQuantity
        }
        uretimEmrindekiMamuller.push(m1);
        doc.process.forEach(function(process){
        	process.output.forEach(function(processOutput){
        		var bFound=false;
        		uretimEmrindekiMamuller.forEach(function(e){
        			var id1=e.item!=undefined?e.item._id:'';
        			var id2=processOutput.item!=undefined?processOutput.item._id:'';
        			var color1=e.color!=undefined?e.color._id:'';
        			var color2=processOutput.color!=undefined?processOutput.color._id:'';
        			var pattern1=e.pattern!=undefined?e.pattern._id:'';
        			var pattern2=processOutput.pattern!=undefined?processOutput.pattern._id:'';
        			var size1=e.size!=undefined?e.size._id:'';
        			var size2=processOutput.size!=undefined?processOutput.size._id:'';

        			if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
        				e.quantity+=processOutput.quantity;
        				bFound=true;
        				return;
        			}
        		});
        		if(!bFound){
        			var m={
        				item:processOutput.item,
        				color:processOutput.color,
        				pattern:processOutput.pattern,
        				size:processOutput.size,
        				quantity:processOutput.quantity
        			}
        			uretimEmrindekiMamuller.push(m);
        		}
        	})

        })
        var lineGridProOrderMamul=document.getElementById('lineGridProOrderMamul');
        while(lineGridProOrderMamul.rows.length>1){
        	lineGridProOrderMamul.deleteRow(0);
        }

        console.log('uretimEmrindekiMamuller:',uretimEmrindekiMamuller)
        console.log('uretimdenStogaGirmisMamuller:',uretimdenStogaGirmisMamuller)
        uretimEmrindekiMamuller.forEach(function(e,index){

        	var kalan=0;
        	var toplam=0;
        	uretimdenStogaGirmisMamuller.forEach(function(e2){
        		var id1=e.item!=undefined?e.item._id:'';
        		var id2=e2.item!=undefined?e2.item._id:'';
        		var color1=e.color!=undefined?e.color._id:'';
        		var color2=e2.color!=undefined?e2.color._id:'';
        		var pattern1=e.pattern!=undefined?e.pattern._id:'';
        		var pattern2=e2.pattern!=undefined?e2.pattern._id:'';
        		var size1=e.size!=undefined?e.size._id:'';
        		var size2=e2.size!=undefined?e2.size._id:'';

        		if(id1==id2 && color1==color2 && pattern1==pattern2 && size1==size2){
        			toplam +=e2.quantity;
        		}

        	})
        	kalan=e.quantity-toplam;

        	var newRow=lineGridProOrderMamul.insertRow(lineGridProOrderMamul.rows.length);
        	if(kalan<0){
        		newRow.classList.add('text-danger');
        		newRow.classList.add('bold');

        	}
        	newRow.insertCell(0).innerHTML=(index+1).n2();
        	var cell1 = newRow.insertCell(1);
        	cell1.innerHTML=e.item==undefined?'':e.item.name.value + (e.item.description.value!=''?' - ' + e.item.description.value:'');
        	cell1.innerHTML+=e.pallet?'<br>Plt:' + e.pallet.name:'';
        	cell1.innerHTML+=e.color?'<br>Renk:' + e.color.name:'';
        	cell1.innerHTML+=e.pattern?'<br>Desen:' + e.pattern.name:'';
        	cell1.innerHTML+=e.size?'<br>Beden:' + e.size.name:'';

        	var cell2=newRow.insertCell(2);
        	cell2.classList.add('text-right');
        	cell2.innerHTML=Number(e.quantity).formatDecimal();
        	var cell3=newRow.insertCell(3);
        	cell3.classList.add('text-right');
        	if(kalan>=0){
        		cell3.innerHTML=Number(kalan).formatDecimal();
        	}else{
        		cell3.innerHTML='(' + Number(kalan).formatDecimal() + ')';
        	}
        });
      }



      function loadForm(){
      	$('#issueDate').val(doc.issueDate);
      	$('#issueTime').val(doc.issueTime);
      	$('#plannedPeriod-startDate').val(doc.plannedPeriod.startDate);
      	$('#plannedPeriod-startTimeHour').val(doc.plannedPeriod.startTime.substr(0,2));
      	$('#plannedPeriod-startTimeMinute').val(doc.plannedPeriod.startTime.substr(3,2));

      	$('#plannedPeriod-endDate').val(doc.plannedPeriod.endDate);
      	$('#plannedPeriod-endTimeHour').val(doc.plannedPeriod.endTime.substr(0,2));
      	$('#plannedPeriod-endTimeMinute').val(doc.plannedPeriod.endTime.substr(3,2));

      	$('#issueTime').val(doc.issueTime);
      	if(doc.productionTypeCode!='') $('#productionTypeCode').val(doc.productionTypeCode);
      	$('#plannedQuantity-quantity').val(doc.plannedQuantity);


      	switch(doc.productionTypeCode){
      		case 'DEPO':
      		if(mode!='view'){
      			$('#production-item-name').removeAttr('readonly');
      			$('#plannedQuantity-quantity').removeAttr('readonly');
      		}
      		$('#forCustomerPanel').hide();

      		break;
      		case 'MUSTERI':
      		if(mode!='view'){
      			$('#production-item-name').prop('readonly',true);
      			$('#plannedQuantity-quantity').prop('readonly',true);
      		}
      		$('#forCustomerPanel').show();

      		break;
      	}
      	loadMainItemAndRecipe(function(err){
      		if(!err){
      			if(doc.productionTypeCode=='MUSTERI') loadOrderLineReference();

      			reloadRecipe();

                // $('#palletType').val((doc.palletType || ''));
                // $('#packingType').val((doc.packingType || ''));
                
                
                if((doc._id || '')==''){
                	calculatePlannedQuantity();
                	paketPaletHesapla();
                	receteUygula();
                }else{
                	if(doc.packingOption){
                		$('#quantityInPacking').val(doc.packingOption.quantityInPacking);
                		$('#palletRowCount').val(doc.packingOption.palletRowCount);
                		$('#packingCountInRow').val(doc.packingOption.packingCountInRow);
                	}
                	$('#totalPallet').val((doc.totalPallet || 0));
                	$('#totalPacking').val((doc.totalPacking || 0));
                }
                
                loadUretimeCikanMalzemeler();
                loadUretimdenGirenMamuller();
              }
            });



      }

      loadForm();

      function uretimeCikisFisi(ficheId=''){
      	if((doc._id || '')=='') return alert('Uretim emrini kaydetmeniz gerekiyor');
      	var url='/inventory/inventory-fiches/';
      	if(ficheId==''){
      		url +='addnew'
      	}else{
      		url +='edit/' + ficheId;
      	}

      	url +='?db=' + q.db + '&sid=' + q.sid +'&productionOrderId=' + doc._id;
      	window.location.href=url;
        // popupCenter(url,'Uretime Cikis Fisi',900,600,true);
      }


      function receteUygula(){
      	doc.sourceRecipe=$('#main-recipe').val() || ''

      	if((doc.item || '')=='') return alert('Urun secilmemis.');
      	if((doc.sourceRecipe || '')=='') return alert('Recete secilmemis.');
      	if(doc.plannedQuantity<=0) return alert('Planlanan miktar sifir dan buyuk olmalidir.');
      	$.ajax({
      		url:`/dbapi/recipes/${doc.sourceRecipe}?sid=${q.sid}`,
      		type:'GET',
      		dataType: 'json',
      		success: function(result) {
      			if(result.success){
      				var recete=result.data;

      				var oran=0;
      				if(recete.totalQuantity>0) oran=doc.plannedQuantity/recete.totalQuantity;
      				if(oran==0) return alert('Recete orani "0" olamaz. Recete miktarlarini kontrol ediniz.');
      				doc.recipeName=recete.name;
      				doc.recipeRevision=recete.revision;
      				doc.description=recete.description;
      				doc.staffCount=recete.staffCount || 0;
      				doc.process=[];
      				doc.materialSummary=[];
      				doc.outputSummary=[];
      				doc.qualityControl=[];
      				recete.process.forEach(function(e){
      					var obj=JSON.parse(JSON.stringify(e));
      					obj.input.forEach(function(e2){
      						e2.quantity=e2.quantity*oran;
      					})
      					obj.output.forEach(function(e2){
      						e2.quantity=e2.quantity*oran;
      					})
      					obj.machines=[];
      					doc.process.push(obj);
      				});

      				recete.materialSummary.forEach(function(e){
      					var obj=JSON.parse(JSON.stringify(e));
      					obj.quantity=obj.quantity * oran;
      					doc.materialSummary.push(obj);
      				});

      				recete.outputSummary.forEach(function(e){
      					var obj=JSON.parse(JSON.stringify(e));
      					obj.quantity=obj.quantity * oran;

      					doc.outputSummary.push(obj);
      				})

      				doc.qualityControl=JSON.parse(JSON.stringify(recete.qualityControl));
      				doc.totalWeight=(recete.totalWeight || 0) * oran;
      				sourceRecipeDoc=clone(recete);
      				reloadRecipe();
      				paketPaletHesapla();
      			}
      		},
      		error:function(err){
      			console.error('err recipes:',err);
      		}
      	});
      }


      function formKaydet(){
      	if((doc.item|| '')=='') return alert('Ürün seçilmemiş');
      	if((doc.sourceRecipe|| '')=='') return alert('Ürün recetesi seçilmemiş');
      	if(($('#issueDate').val() || '')=='') return alert('Üretim tarihi giriniz.');

      	doc.productionId=$('#productionId').val();
      	doc.issueDate=$('#issueDate').val();
      	doc.issueTime=$('#issueTime').val();
      	doc.plannedPeriod.startDate=$('#plannedPeriod-startDate').val();
      	if($('#plannedPeriod-startDate').val()==''){
      		doc.plannedPeriod.startTime='';
      	}else{
      		doc.plannedPeriod.startTime=$('#plannedPeriod-startTimeHour').val() + ':' + $('#plannedPeriod-startTimeMinute').val();
      	}

      	doc.plannedPeriod.endDate=$('#plannedPeriod-endDate').val();
      	if($('#plannedPeriod-endDate').val()==''){
      		doc.plannedPeriod.endTime='';
      	}else{
      		doc.plannedPeriod.endTime=$('#plannedPeriod-endTimeHour').val() + ':' + $('#plannedPeriod-endTimeMinute').val();
      	}


      	if(doc.productionTypeCode=='DEPO'){
      		doc.orderLineReference.splice(0);
      	}

      	if(($('#choosePackingOption').val() || '')!=''){
      		doc.packingOption=JSON.parse(decodeURIComponent($('#choosePackingOption').val()));
      		doc.packingOption.quantityInPacking=Number($('#quantityInPacking').val());
      		doc.packingOption.palletRowCount=Number($('#palletRowCount').val());
      		doc.packingOption.packingCountInRow=Number($('#packingCountInRow').val());
      	}



      	doc.totalPallet=Number($('#totalPallet').val());
      	doc.totalPacking=Number($('#totalPacking').val());


      	saveRecipe((err)=>{
      		if(!err){
      			goBack();
      		}else{
      			alert(err.message);
      		}
      	});
      }

      function approve(){
      	if(!confirm("Üretim emrini onaylamak istiyor musunuz?")) return;
      	$.ajax({
      		url:`/dbapi/production-orders/approve/${doc._id}?sid=${q.sid}`,
      		data:{},
      		type:'POST',
      		success:function(result){
      			if(result.success){
                    //alert('Aktarim basladi.');
                    goBack();
                  }else{
                  	alert(result.error);
                  }
                }
              });
      }

      function decline(){
      	if(!confirm("Üretim emri reddetmek istiyor musunuz?")) return;
      	$.ajax({
      		url:`/dbapi/production-orders/decline/${doc._id}?sid=${q.sid}`,
      		data:{},
      		type:'POST',
      		success:function(result){
      			if(result.success){
                    //alert('Aktarim basladi.');
                    goBack();
                  }else{
                  	alert(result.error);
                  }
                }
              });
      }

      function start(){
      	if(!confirm("Üretim emrini baslatmak istiyor musunuz?"))
      		return
      	$.ajax({
      		url:`/dbapi/production-orders/start/${doc._id}?sid=${q.sid}`,
      		data:{},
      		type:'POST',
      		success:function(result){
      			if(result.success){
                    //alert('Aktarim basladi.');
                    goBack();
                  }else{
                  	alert(result.error);
                  }
                }
              });
      }

      function makeDraftBack(){
      	if(!confirm("Üretim emrinin taslak haline döndürülmesini istiyor musunuz?"))
      		return
      	$.ajax({
      		url:`/dbapi/production-orders/setDraft/${doc._id}?sid=${q.sid}`,
      		data:{},
      		type:'POST',
      		success:function(result){
      			if(result.success){
                    //alert('Aktarim basladi.');
                    goBack();
                  }else{
                  	alert(result.error);
                  }
                }
              });
      }

      function complete(){
      	if(!confirm("Üretim emri tamamlanacaktır. Üretilenler stoğa eklenecektir. Onaylıyor musunuz?"))
      		return
      	$.ajax({
      		url:`/dbapi/production-orders/complete/${doc._id}?sid=${q.sid}`,
      		data:{},
      		type:'POST',
      		success:function(result){
      			if(result.success){
                    //alert('Aktarim basladi.');
                    goBack();
                  }else{
                  	alert(result.error);
                  }
                }
              });
      }

      $(document).ready(function(){

      	$('select[name="productionTypeCode"]').change(function(){
      		doc.productionTypeCode=$('#productionTypeCode').val();

      		switch($('select[name="productionTypeCode"]').val()){
      			case 'DEPO':
      			$('#production-item-name').removeAttr('readonly');
      			$('#plannedQuantity-quantity').removeAttr('readonly');
      			$('#forCustomerPanel').hide();
      			doc.item=$("#production-item-id").val();
      			break;
      			case 'MUSTERI':
      			$('#production-item-name').prop('readonly',true);
      			$('#plannedQuantity-quantity').prop('readonly',true);
      			$('#forCustomerPanel').show();
      			loadOrderLineReference();
      			break;
      		}

      		loadMainItemAndRecipe();
      		calculatePlannedQuantity();
      	});


      	$('#production-item-name').autocomplete({
      		source:function(request,response){
      			$.ajax({
      				url:`/dbapi/items?sid=${q.sid}&itemType=product&name=${encodeURIComponent2(request.term)}`,
      				type:'GET',
      				dataType: 'json',
      				success: function(result) {
      					if(result.success){
      						var dizi=[];
      						for(var i=0;i<result.data.docs.length;i++){
      							var item=result.data.docs[i];

      							dizi.push({name:item.name.value, label:(getItemTypeName(item.itemType) + ' - ' + item.name.value),value:item._id});
      						}
      						if(dizi.length>0){
      							$('#cbNewItemPanel').hide();
      						}else{
      							$('#cbNewItemPanel').show();
      						}
      						response(dizi);
      					}
      				},
      				error:function(err){
      					console.error('err:',err);
      				}
      			});
      		},
      		select: function (event, ui) {
      			$("#production-item-name").val(ui.item.name); 
      			$("#production-item-id").val(ui.item.value);
      			doc.item=ui.item.value;

      			loadMainItemAndRecipe();
      			return false;
      		}
      	});
      });
    </script>