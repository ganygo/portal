<%


%>
<!-- <div class="row">
    <div class="form-group col-md-5">
        <label for="" class="m-0">Ürüne ait reçeteler</label>
        <select class="form-control" name="productRecipes" id="productRecipes" onchange="productRecipesChange()">
        </select>
    </div>
    <div class="form-group col-md-3 form-inline">
        <label for="recipeIsDefault" class="m-0 mt-3">Varsayılan?</label>
        <input type="checkbox" class="ml-3 mt-3" name="recipeIsDefault" id="recipeIsDefault" checked="false">
    </div>
    <div class="form-group col-md-4 text-right">
        <a href="javascript:yazdir();" class="btn btn-info mt-3" title="Yazdir"><i class="fas fa-print"></i></a>
        <a href="javascript:receteKaydet();" class="btn btn-primary mt-3"  title="Recete kaydet"><i class="fas fa-save"></i></a>
        <a href="javascript:receteSil();" class="btn btn-danger mt-3 ml-2"  title="Recete sil"><i class="fas fa-trash-alt"></i></a>
    </div>
    
</div> -->
<div class="row">
    <div class="form-group col-md-6">
        <label for="" class="m-0">Recete Adı</label>
        <input type="text" class="form-control" name="recipeName" id="recipeName" placeholder="Recete Adı"  value="">
    </div>
    <div class="form-group col-md-2">
        <label for="" class="m-0">Revizyon</label>
        <input type="number" class="form-control" name="recipeRevision" id="recipeRevision"  value="1">
    </div>
    <div class="form-group col-md-12">
        <label for="" class="m-0">Açıklama</label>
        <input type="text" class="form-control" name="recipeDescription" id="recipeDescription" placeholder="Açıklama" value="">
    </div>
</div>
<div class="row">
    <div class="col-md-12">
        <table class="table form-table table-bordered table-striped m-0 shadow"  cellspacing="0">
            <thead>
                <tr class="text-nowrap">
                    <th width="30" class=""><input type="checkbox" class="mt-1" value="true" name="selectAll" id="selectAll"></th>
                    <th width="50" class="">No</th>
                    <th width="15%" class="">Istasyon</th>
                    <th width="15%" class="">Adım</th>
                    <th width="20%" class="">Malzeme</th>
                    <th width="30%">Parametreler</th>
                    <th width="80" class="text-center">
                        <a href="javascript:addNewRecipeLine();" class="btn btn-primary far fa-plus-square"  title="Yeni satir"></a>
                    </th>
                </tr>
            </thead>
            <tbody id="recipe1">
                
            </tbody>
        </table>
    </div>
</div>
<div class="row mt-2">
    <div class="col-md-6">
        <div class="card mt-2">
            <div class="card-header p-1 text-primary">Malzeme Toplami</div>
            <div class="card-body p-1">
                <table class="table form-table table-bordered table-striped m-0"  cellspacing="0">
                    <thead>
                        <tr class="text-nowrap">
                            <th width="70%">Malzeme</th>
                            <th width="30%">Miktar</th>
                            
                        </tr>
                    </thead>
                    <tbody id="materialSummaryGrid">
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    <div class="col-md-6">
        <div class="card mt-2">
            <div class="card-header p-1 text-primary">Yan ürünler/katalizörler</div>
            <div class="card-body p-1">
                <table class="table form-table table-bordered table-striped m-0"  cellspacing="0">
                    <thead>
                        <tr class="text-nowrap">
                            <th width="70%">Yan ürün/Katalizör</th>
                            <th width="30%">Miktar</th>
                        </tr>
                    </thead>
                    <tbody id="outputSummaryGrid">
                        
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="recipeLineModal" data-backdrop="static" data-keyboard="false" tabindex="-1" role="dialog" aria-labelledby="recipeLineModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-scrollable modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header p-2 ">
                <label class="modal-title" id="recipeLineModalLabel">Recete/Proses Adım</label>
                <button class="close" type="button" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body p-2">
                <div class="row">
                    <div class="form-group col-md-6">
                        <label for="" class="m-0">Üretim İstasyonu/Prosess</label>
                        <select class="form-control" name="station" id="station">
                            <% stationList.forEach((e)=>{ %>
                            <option value="<%=e._id%>"><% if(e._id==''){%>---<%}else{%><%=e.name%><%}%></option>
                            <% }); %>
                        </select>
                    </div>
                    <div class="form-group col-md-6">
                        <label for="" class="m-0">İşlem/Adım</label>
                        <select class="form-control" name="processStep" id="processStep" onchange="processStepChange()">
                            <% stepList.forEach((e)=>{ %>
                            <option value="<%=e._id%>"><% if(e._id==''){%>---<%}else{%><%=e.name%><%}%></option>
                            <% }); %>
                        </select>
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-12">
                        <div class="form-group">
                            <label for="" class="m-0">Parametreler/Notlar</label>
                            <textarea id="parameters" class="form-control" rows="4"></textarea>
                        </div>
                    </div>
                </div>
                <div class="useMaterial">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link active" href="#tab1" role="tab" data-toggle="tab" id="IDtab1" aria-controls="tab1" aria-selected="true">
                                <i class="fas fa-file-alt"></i> Malzemeler
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="#tab2" role="tab" data-toggle="tab" id="IDtab2" aria-controls="tab2" aria-selected="false">
                                <i class="fas fa-table"></i> İşlem sonrası çıkan yan ürünler/malzemeler
                            </a>
                        </li>
                        
                    </ul>
                    <div class="tab-content p-1 " style="min-height:35vh;overflow: auto;">
                        <!-- IDtab1 -->
                        <div class="tab-pane show active" id="tab1" role="tabpanel" aria-labelledby="IDtab1">
                            <div class="row">
                                <div class="form-group col-md-3">
                                    <label for="" class="m-0">Malzeme</label>
                                    <select class="form-control" name="itemTypeInput" id="itemType" onchange="itemTypeChange()">
                                        <option value="raw-material">Hammadde</option>
                                        <option value="helper-material">Yardimci Malzeme</option>
                                        <option value="product">Mamul/Yari mamul</option>
                                        <option value="item">Stok Envanter</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="" class="m-0">Seç</label>
                                    <input type="text" form="form-general" name="itemName" id="itemName" placeholder="ara"  class="form-control" autocomplete="off" value="">
                                    <input type="text" form="form-general" name="itemId"  id="itemId" hidden="true" value="">
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="" class="m-0">Miktar</label>
                                    <input type="number" class="form-control" name="quantity" id="quantity" placeholder="" value="0">
                                </div>
                                <div class="form-group col-md-1">
                                    <label for="" class="m-0">#</label>
                                    <a href="javascript:addInputMaterial();" class="btn btn-primary fas fa-plus-square"  title="Malzeme Ekle"></a>
                                </div>
                            </div>
                            <table class="table form-table table-bordered table-striped m-0 "  cellspacing="0" style="display: grid;overflow-y:scroll; max-height: 15rem;">
                                
                                <tbody id="materialInputGrid">
                                    
                                </tbody>
                            </table>
                        </div>

                        <!-- IDtab2 -->
                        <div class="tab-pane" id="tab2" role="tabpanel" aria-labelledby="IDtab2">
                            <div class="row">
                                <div class="form-group col-md-3">
                                    <label for="" class="m-0">Yan ürün veya katalizör</label>
                                    <select class="form-control" name="itemTypeOutput" id="itemTypeOutput" onchange="itemTypeOutputChange()">
                                        <option value="raw-material">Hammadde</option>
                                        <option value="helper-material" selected>Yardimci Malzeme</option>
                                        <option value="product">Mamul/Yari mamul</option>
                                        <option value="item">Stok Envanter</option>
                                    </select>
                                </div>
                                <div class="form-group col-md-6">
                                    <label for="" class="m-0">Seç</label>
                                    <input type="text" form="form-general" name="itemNameOutput" id="itemNameOutput" placeholder="ara"  class="form-control" autocomplete="off" value="">
                                    <input type="text" form="form-general" name="itemIdOutput"  id="itemIdOutput" hidden="true" value="">
                                </div>
                                <div class="form-group col-md-2">
                                    <label for="" class="m-0">Miktar</label>
                                    <input type="number" class="form-control" name="quantityOutput" id="quantityOutput" placeholder="" value="0">
                                </div>
                                <div class="form-group col-md-1">
                                    <label for="" class="m-0">#</label>
                                    <a href="javascript:addOutputMaterial();" class="btn btn-primary fas fa-plus-square"  title="Yan ürün Ekle"></a>
                                </div>
                            </div>
                            <table class="table form-table table-bordered table-striped m-0 "  cellspacing="0" style="display: grid;overflow-y:scroll; max-height: 15rem;">
                                <tbody id="materialOutputGrid">
                                    
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" type="button" data-dismiss="modal">Vazgeç</button>
                <a id="recipeLineModalSaveButton" class="btn btn-primary" href="javascript:saveRecipeLine(-1)">Tamam</a>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">

    
    var aktifReceteAdim=-1;
    var lineMaterialInputs=[];
    var lineMaterialOutputs=[];
   

    function yazdir(){
        //qwerty uretim fisi yazdirma
        popupCenter('/general/print/preview?db=<%=db%>&sid=<%=sid%>&path=/recipes/' + (doc._id || ''),'Recete','900','600');
    }
    

    function reloadRecipe(){
        $('#recipe1 tr').remove();
        $('#materialSummaryGrid tr').remove();
        $('#outputSummaryGrid tr').remove();
        var recipe1=document.getElementById('recipe1');

        var materialSummaryGrid=document.getElementById('materialSummaryGrid');
        var outputSummaryGrid=document.getElementById('outputSummaryGrid');

        // $('#recipeName').val((doc.name || ''));
        $('#recipeDescription').val((doc.description || ''));
        //$('#recipeRevision').val((doc.revision || 1));
        
        if(doc.isDefault==true){
            $('#recipeIsDefault').prop('checked',true);
        }else{
            $('#recipeIsDefault').prop('checked',false);
        }

        if(doc.process!=undefined){
            doc.process.forEach(function(e,index){
                var newRow=recipe1.insertRow(recipe1.rows.length);
                newRow.insertCell(0).innerHTML='<input type="checkbox" value="true" />';
                newRow.insertCell(1).innerHTML=(index+1).toString();
                newRow.insertCell(2).innerHTML=e.station.name;
                newRow.insertCell(3).innerHTML=e.step.name;
                var malzemeler='';
                if(e.input!=undefined){
                    e.input.forEach(function(e1,index1){
                        malzemeler +=e1.item.name.value + ' ' + e1.quantity + ' ' + e1.unitCode;
                        if(index1<e.input.length-1){
                            malzemeler += '<br />';
                        }
                    });
                }
                newRow.insertCell(4).innerHTML=malzemeler;
                newRow.insertCell(5).innerHTML=e.parameters;
                var cell6=newRow.insertCell(6);
                cell6.classList.add('text-center');
                cell6.innerHTML='<a href="javascript:editRecipeLine(' + index + ');" class="btn btn-primary btn-sm fas fa-edit"  title="Duzenle"></a>' +
                '<a href="javascript:removeRecipeLine(' + index + ');" class="ml-2 btn btn-danger btn-sm fas fa-trash-alt"  title="Sil"></a>';
               
            });
        }

        if(doc.materialSummary!=undefined){
            doc.materialSummary.forEach(function(e){
                var newRow=materialSummaryGrid.insertRow(materialSummaryGrid.rows.length);
                newRow.insertCell(0).innerHTML=e.item.name.value;
                newRow.insertCell(1).innerHTML=e.quantity + ' ' + e.unitCode;
            });
        }
        if(doc.outputSummary!=undefined){
            doc.outputSummary.forEach(function(e){
                var newRow=outputSummaryGrid.insertRow(outputSummaryGrid.rows.length);
                newRow.insertCell(0).innerHTML=e.item.name.value;
                newRow.insertCell(1).innerHTML=e.quantity + ' ' + e.unitCode;
            });
        }
    }

    function addNewRecipeLine(){
        aktifReceteAdim=-1;
        saveRecipe((err)=>{
            if(!err){
                $('#itemId').val('');
                $('#itemName').val('');
                $('#quantity').val(0);
                $('#itemIdOutput').val('');
                $('#itemNameOutput').val('');
                $('#quantityOutput').val(0);
                lineMaterialInputs=[];
                lineMaterialOutputs=[];
                refresh_materialInputGrid();
                refresh_materialOutputGrid();
                $('#recipeLineModal').modal('show');
            }else{
                alert(err.message);
            }
        });
    }

    function editRecipeLine(index){
        aktifReceteAdim=index;
        $('#itemId').val('');
        $('#itemName').val('');
        $('#quantity').val(0);
        $('#itemIdOutput').val('');
        $('#itemNameOutput').val('');
        $('#quantityOutput').val(0);
        saveRecipe((err)=>{
            if(!err){
                $('#station').val(doc.process[index].station._id);
                $('#processStep').val(doc.process[index].step._id);
                $('#parameters').val(doc.process[index].parameters);
                processStepChange();
                lineMaterialInputs=doc.process[index].input;
                lineMaterialOutputs=doc.process[index].output;
                refresh_materialInputGrid();
                refresh_materialOutputGrid();
                $('#recipeLineModal').modal('show');
            }else{
                alert(err.message);
            }
        });
    }

    function removeRecipeLine(index){
        if(confirm('Recete adimini cikarmak istiyor musunuz?')==false) return;
        if(index>-1 && index<doc.process.length){
            doc.process.splice(index,1);
        }
    }

    function addInputMaterial(){
        if($('#itemId').val()=='') return;
        if(Number($('#quantity').val())<=0) return;
        
        var bFound=false;
        lineMaterialInputs.forEach(function(e){
            if(e.item._id==$('#itemId').val()){
                bFound=true;
                return;
            }
        });
        if(bFound){
            alert('Bu malzeme zaten eklenmis');
            return;
        }
        var obj={
            item:{
                _id:$('#itemId').val(),
                name:{value:$('#itemName').val()},
                itemType:$('#itemType').val()
            },
            quantity:Number($('#quantity').val()),
            unitCode:'kg'
        }
        lineMaterialInputs.push(obj);
        $('#itemId').val('');
        $('#itemName').val('');
        $('#quantity').val(0);
        refresh_materialInputGrid();
        $('#itemName').focus();
    }

    function removeInputMaterial(index){
        if(confirm('Malzemeyi cikarmak istiyor musunuz?')==false) return;

        lineMaterialInputs.splice(index,1);
        refresh_materialInputGrid();
    }
    function refresh_materialInputGrid(){
        $("#materialInputGrid tr").remove();
        var materialInputGrid=document.getElementById('materialInputGrid');

        lineMaterialInputs.forEach(function(e,index){
            var newRow=materialInputGrid.insertRow(materialInputGrid.rows.length);
            //newRow.classList.add('text-nowrap');
            var itemTypeNickName='HM';
            switch(e.item.itemType){
                
                case 'raw-material': itemTypeNickName='Hammadde'; break;
                case 'helper-material': itemTypeNickName='Yardımcı Malz.'; break;
                case 'product': itemTypeNickName='Mamul'; break;
                case 'semi-product': itemTypeNickName='Yarı Mamul'; break;
                default: itemTypeNickName='Stok'; break;
            }
            var cell0=newRow.insertCell(0);
            cell0.width='20%';
            cell0.innerHTML=itemTypeNickName;

            var cell1=newRow.insertCell(1);
            cell1.width='55%';
            cell1.innerHTML=e.item.name.value;
            
            var cell2=newRow.insertCell(2);
            cell2.width='20%';
            cell2.innerHTML=e.quantity + ' ' + e.unitCode;

            var cell3=newRow.insertCell(3);
            cell3.width='60';
            cell3.innerHTML='<a href="javascript:removeInputMaterial(' + index + ');" class="btn btn-danger btn-sm fas fa-trash-alt" title="Sil"></a>';
        })
    }

    function addOutputMaterial(){
        if($('#itemIdOutput').val()=='') return;
        if(Number($('#quantityOutput').val())<=0) return;
        
        var bFound=false;
        lineMaterialOutputs.forEach(function(e){
            if(e.item._id==$('#itemIdOutput').val()){
                bFound=true;
                return;
            }
        });
        if(bFound){
            alert('Bu malzeme zaten eklenmis');
            return;
        }
        var obj={
            item:{
                _id:$('#itemIdOutput').val(),
                name:{value:$('#itemNameOutput').val()},
                itemType:$('#itemTypeOutput').val()
            },
            quantity:Number($('#quantityOutput').val()),
            unitCode:'kg'
        }
        lineMaterialOutputs.push(obj);
        $('#itemIdOutput').val('');
        $('#itemNameOutput').val('');
        $('#quantityOutput').val(0);
        refresh_materialOutputGrid();
        $('#itemNameOutput').focus();
    }

    function removeOutputMaterial(index){
        if(confirm('Malzemeyi cikarmak istiyor musunuz?')==false) return;

        lineMaterialOutputs.splice(index,1);
        refresh_materialOutputGrid();
    }
    function refresh_materialOutputGrid(){
        $("#materialOutputGrid tr").remove();
        var materialOutputGrid=document.getElementById('materialOutputGrid');

        lineMaterialOutputs.forEach(function(e,index){
            var newRow=materialOutputGrid.insertRow(materialOutputGrid.rows.length);
            //newRow.classList.add('text-nowrap');
            var itemTypeNickName='HM';
            
            switch(e.item.itemType){
                
                case 'raw-material': itemTypeNickName='Hammadde'; break;
                case 'helper-material': itemTypeNickName='Yardımcı Malz.'; break;
                case 'product': itemTypeNickName='Mamul'; break;
                case 'semi-product': itemTypeNickName='Yarı Mamul'; break;
                default: itemTypeNickName='Stok'; break;
            }
            var cell0=newRow.insertCell(0);
            cell0.width='20%';
            cell0.innerHTML=itemTypeNickName;

            var cell1=newRow.insertCell(1);
            cell1.width='55%';
            cell1.innerHTML=e.item.name.value;
            
            var cell2=newRow.insertCell(2);
            cell2.width='20%';
            cell2.innerHTML=e.quantity + ' ' + e.unitCode;

            var cell3=newRow.insertCell(3);
            cell3.width='60';
            cell3.innerHTML='<a href="javascript:removeOutputMaterial(' + index + ');" class="btn btn-danger btn-sm fas fa-trash-alt" title="Sil"></a>';
        })
    }

    function saveRecipeLine(){
        if($('#station').val()==''){
            alert('Lütfen üretim istasyonu seçiniz!');
            $('#station').focus();
            return;
        }
        if($('#processStep').val()==''){
            alert('Lütfen İşlem/Adım seçiniz!');
            $('#processStep').focus();
            return;
        }
        var obj={
            station:$('#station').val(),
            step:$('#processStep').val(),
            input:[],
            output:[],
            parameters:$('#parameters').val()
        }
        lineMaterialInputs.forEach(function(e){
            obj.input.push({item:e.item._id,quantity:e.quantity,unitCode:e.unitCode});
        });
        lineMaterialOutputs.forEach(function(e){
            obj.output.push({item:e.item._id,quantity:e.quantity,unitCode:e.unitCode});
        });
        if(aktifReceteAdim<0){
            doc.process.push(obj);
        }else{
            doc.process[aktifReceteAdim]=obj;
        }
        saveRecipe(function(err){
            if(!err){
                reloadRecipe();
                $('#recipeLineModal').modal('hide');
            }
        })
    }
    
    function itemTypeChange(){
        $('#itemName').val('');
        $('#itemId').val('');
    }
    function itemTypeOutputChange(){
        $('#itemNameOutput').val('');
        $('#itemIdOutput').val('');
    }
    var stepList=JSON.parse(decodeURIComponent('<%- encodeURIComponent(JSON.stringify(stepList)) %>'));
    if(stepList.length>0) stepList[0].name='---';

    function processStepChange(){

        $('.useMaterial').hide();
        stepList.forEach(function(e){
            if(e._id==$('#processStep').val()){
                if(e.useMaterial){
                    $('.useMaterial').show();
                }
                return;
            }
        });
    }

    

    function saveRecipe(callback){
        recipe['name']=$('#recipeName').val();
        recipe['description']=$('#recipeDescription').val();
        recipe['revision']=Number($('#recipeRevision').val());
        recipe['isDefault']=$('#recipeIsDefault').prop('checked');
        
        var type='POST';
        var url='/dbapi/recipes?db=<%=db%>&sid=<%=sid%>';
        if(doc._id!=undefined){
            type='PUT';
            url='/dbapi/recipes/' + doc._id + '?db=<%=db%>&sid=<%=sid%>';
        }


        $.ajax({
            url:url,
            data:recipe,
            type:type,
            success:function(result){
                if(result.success){
                    recipe=result.data;
                    callback(null);
                }else{
                    callback(result.error);
                }
            }
        });
    }

    // function receteKaydet(){
    //     saveRecipe((err)=>{
    //         if(!err){
    //             refreshRecipeList((doc._id || ''));

    //         }
    //     });
    // }
    $(document).ready(function(){
        $( "#itemName" ).keypress(function( event ) {
          if ( event.which == 13 ) {
            event.preventDefault();
            $( "#quantity").focus();
          }
        });
        $( "#itemNameOutput" ).keypress(function( event ) {
          if ( event.which == 13 ) {
            event.preventDefault();
            $( "#quantityOutput").focus();
          }
        });
        $( "#quantity" ).keypress(function( event ) {
          if ( event.which == 13 ) {
            event.preventDefault();
            addInputMaterial();
          }
        });
        $( "#quantityOutput" ).keypress(function( event ) {
          if ( event.which == 13 ) {
            event.preventDefault();
            addOutputMaterial();
          }
        });

        $('#itemName').autocomplete({
            source:function(request,response){
                    var itemType=$('#itemType').val();
                    $.ajax({
                    url:'/dbapi/items?itemType=' + itemType + '&name=' +  encodeURIComponent(request.term) + '&db=<%=db%>&sid=<%=sid%>',
                    type:'GET',
                    dataType: 'json',
                    success: function(result) {
                            if(result.success){
                                var dizi=[];
                                for(var i=0;i<result.data.docs.length;i++){
                                    var item=result.data.docs[i];
                                    
                                    dizi.push({label:(item.name.value),value:item._id});
                                }
                                response(dizi);
                            }
                        },
                    error:function(err){
                        console.error('err:',err);
                    }
                });
            },
            select: function (event, ui) {
                    $("#itemName").val(ui.item.label); 
                    $("#itemId").val(ui.item.value); 
                    return false;
                }
        });

        $('#itemNameOutput').autocomplete({
            source:function(request,response){
                    var itemType=$('#itemTypeOutput').val();
                    $.ajax({
                    url:'/dbapi/items?itemType=' + itemType + '&name=' +  encodeURIComponent(request.term) + '&db=<%=db%>&sid=<%=sid%>',
                    type:'GET',
                    dataType: 'json',
                    success: function(result) {
                            if(result.success){
                                var dizi=[];
                                for(var i=0;i<result.data.docs.length;i++){
                                    var item=result.data.docs[i];
                                    
                                    dizi.push({label:(item.name.value),value:item._id});
                                }
                                response(dizi);
                            }
                        },
                    error:function(err){
                        console.error('err:',err);
                    }
                });
            },
            select: function (event, ui) {
                    $("#itemNameOutput").val(ui.item.label); 
                    $("#itemIdOutput").val(ui.item.value); 
                    return false;
                }
        });

        // refreshRecipeList();
    });
</script>
