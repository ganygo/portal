<%
title='Bekleyen Şiparişler';
%>
<%layout('../../_common/layouts/general')%>
<form action="" method="POST" role="form" name="form1">
	<div class="row m-0 mt-2">
		<div class="col-12 p-0">
			<%- partial('../../_common/components/date-filter',{includeForm:false,includeFilterButton:false}) %>
			
			<div class="float-left form-inline ml-md-4">
				<label class="text-primary">Senaryo:</label>
				<select class="form-control input-inline input-sm" name="profileId" id="profileId">
					<% docProfileIdList.forEach((e)=>{ %> 
					<option value="<%=e.value%>"<% if(typeof filter.profileId!='undefined') if(filter.profileId==e.value){%>selected<% } %>><%=e.text%></option>
					<% }) %>
				</select>
			</div>
			<div class="float-left form-inline ml-md-2">
				<label class="text-primary">Sipariş Türü:</label>
				<select class="form-control input-inline input-sm" name="orderTypeCode" id="orderTypeCode">
					<% docTypeCodeList.forEach((e)=>{ %> 
					<option value="<%=e.value%>"<% if(typeof filter.orderTypeCode!='undefined') if(filter.orderTypeCode==e.value){%>selected<% } %>><%=e.text%></option>
					<% }) %>
				</select>
			</div>
			<div class="float-md-right">
				<button type="submit" name="btnFilter" class="btn btn-primary" value="true"><i class="fa fa-filter"></i> Filtrele</button>
			</div>
		</div>
	</div>
</form>

<%
panelButtons=`
<button type="button" class="btn btn-primary mr-2" id="btnProductionOrder">Üretim Emri ver</button>
<button type="button" class="btn btn-info mr-2" id="btnSendToCustomer">Sevk et</button>
`
%>

<%- partial('../../_common/components/grid2',{
	fields:[
	{name:'orderTypeCode.value',text:'Türü',type:'label', orderable:true},
	{name:'sipNo',text:'Sip.No',type:'label', filterField:'orderNo', filter:true,orderable:true},
	{name:'issueDate.value',text:'Sip. Tarihi',type:'label', orderable:true},
	{name:'termin',text:'Termin',type:'label', orderable:true},
	{name:'buyerCustomerParty.party.partyName.name.value',text:'Musteri',type:'label', filter:true, orderable:true},
	{name:'orderLine.item.name.value',text:'Ürün',type:'label'},
	{name:'orderLine.orderedQuantity.value',text:'Sip. Miktar',type:'label'},
	{name:'deliveredRemaining',text:'Kalan',type:'label' },
	{name:'producedRemaining',text:'Üretilecek',type:'label' },
	{name:'salesOrderId.value',text:'Müşteri Sip. No',filterField:'salesOrderId',filter:true,type:'label' }
	],
	caption:'Bekleyen Siparisler',
	//addNewButton:true,
	viewButton:false,
	//editButton:true,
	//deleteButton:true,
	selection:true,
	//customButtons:[
	//	{href:'javascript:popupCenter("/order/outbox/view/{_id}?sid=${sid}` + '","Ön izleme","900","600");', text:'Goruntule',icon:'fas fa-search-plus'},
	//	{href:'/order/outbox/pdf/{_id}?sid=${sid}`, text:'Pdf',icon:'fas fa-file-pdf'}
	//],
	//deleteUrl:`/dbapi/order/order/{_id}?sid=${sid}`
}) 
%>

<script type="text/javascript">
	var q=getAllUrlParams();
	$(document).ready(function(){
		$('#btnProductionOrder').click(()=>{
			var data={list:[]};
			var bFarkliUrunVar=false;
			var toplamUretilecek=0;
			var itemId='';
			var orderLineId='';

			$(".checkSingle").each(function(){
				if(this.checked){
					var doc=JSON.parse(decodeURIComponent(this.value));
					data.list.forEach((e)=>{
						if(e.itemId!=doc.orderLine.item._id){
							bFarkliUrunVar=true;
							return;
						}
					})
					if(bFarkliUrunVar)
						return;
					toplamUretilecek+=doc.producedRemaining;
					data.list.push({itemId:doc.orderLine.item._id, _id:doc._id,producedRemaining:doc.producedRemaining});
					itemId=doc.orderLine.item._id;
					orderLineId+=doc.orderLine._id + ',';
				}
			});
			if(data.list.length==0)
				return alertX('Kayıt seçilmemiş!','Uyarı')
			if(bFarkliUrunVar) 
				return alertX('Üretim emrine aynı ürüne sahip siparişleri ekleyebilirsiniz.','Uyarı')


			confirmX(`${data.list.length} sipariş üretilecektir. Onaylıyor musunuz?`,(resp)=>{
				if(resp){
					window.location.href=`${window.location.origin}/mrp/production-orders/addnew?sid=${q.sid}&itemId=${itemId}&orderLineId=${orderLineId}`
				}
			})
		})

		$('#btnSendToCustomer').click(()=>{
			alertX('qwerty siparisten sevk','qwerty')
		});
	});
</script>