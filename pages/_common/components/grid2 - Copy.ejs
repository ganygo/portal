<%




    if(typeof dataSourceUrl=='undefined') dataSourceUrl='';
    if(typeof showSearch=='undefined') showSearch=false;
    if(typeof filter=='undefined') filter={};

    if(typeof addNewButton=='undefined') addNewButton=false;
    if(typeof editButton=='undefined') editButton=false;
    if(typeof deleteButton=='undefined') deleteButton=false;
    if(typeof viewButton=='undefined') viewButton=false;
    if(typeof selection=='undefined') selection=false;
    
    
    var ctrlCol=0;
    if(editButton) ctrlCol++;
    if(deleteButton) ctrlCol++;
    if(viewButton) ctrlCol++;
    if(typeof customButtons!='undefined') {
        
        for(var i=0;i<customButtons.length;i++){
            
            if(typeof customButtons[i].icon=='undefined') customButtons[i].icon='';
            if(typeof customButtons[i].text=='undefined') customButtons[i].text='';
            if(typeof customButtons[i].title=='undefined') customButtons[i].title='';

        }
    }
    if(addNewButton){
        if(typeof pageHeaderButtons=='undefined'){
            pageHeaderButtons={visible:true, addNew:true}
        }else{
            pageHeaderButtons['visible']=true;
            pageHeaderButtons['addNew']=true;
        }
        
        if(typeof backUrl!='undefined'){
            pageHeaderButtons['back']=true;
            pageHeaderButtons['backUrl']=backUrl;
        }
    }
    var showFilterRow=false;

    fields.forEach((field)=>{
        if(typeof field.type=='undefined') field['type']='label';

        if(typeof field.valueField=='undefined') field['valueField']='value';
        if(typeof field.textField=='undefined') field['textField']='text';
        if(typeof field.icon=='undefined') field['icon']='';

        if(typeof field.path=='undefined') field['path']='';
        if(typeof field.buttonTarget=='undefined') field['buttonTarget']='_self';
        if(typeof field.filterField=='undefined') field.filterField=field.name;
        if(typeof field.dontUseLookup=='undefined') field.dontUseLookup=false;

        if(typeof field.filter!='undefined'){
            if(field.filter){
                showFilterRow=true;
            }
        }else{
            field.filter=false;
        }

        

        if(typeof filter[field.filterField]!='undefined'){
            field.filterValue=filter[field.filterField];
        }else{
            field.filterValue='';
        }
    });


%>

<div class="table-responsive mt-1">
    <div class="row m-0 border">
        <div class="col-12 pt-1 px-1">
            <div class="float-left form-inline m-0 p-0 mt-1 mb-1">
                <% if(showFilterRow){ %>
                <a class="btn btn-secondary btn-sm mr-3" data-toggle="collapse" href="#filterRow" role="button" aria-expanded="false" aria-controls="filterRow" title="Filtre satırını göster/gizle">
                    <i class="fas fa-filter"></i>    
                </a>
                <% } %>
                <% if(typeof pageSize!='undefined'){ %>
                <div class="form-group" style="display: inline-block;">
                    Sayfada
                    <select class="form-control input-inline input-sm" name="pageSize" id="pageSize">
                        <option value="10"<% if(pageSize==10){%> selected<%}%>>10</option>
                        <option value="20"<% if(pageSize==20){%> selected<%}%>>20</option>
                        <option value="50"<% if(pageSize==50){%> selected<%}%>>50</option>
                        <option value="100"<% if(pageSize==100){%> selected<%}%>>100</option>
                        <option value="250"<% if(pageSize==250){%> selected<%}%>>250</option>
                        <option value="500"<% if(pageSize==500){%> selected<%}%>>500</option>
                    </select>
                </div>
                <% } %>
                <div class="" style="display: inline-block;">
                    <% if(typeof pageSize!='undefined'){ %>
                        <%=((page-1)*pageSize)+1%> - <% if(page*pageSize<recordCount) {%><%=page*pageSize%><%} else {%><%=recordCount%><%} %> arasi, Toplam: <%=recordCount%> kayit, <%=pageCount%> sayfa
                    <% } else if(typeof recordCount!='undefined'){ %>
                        Toplam: <%=recordCount%> kayit
                    <% } %>
                </div>
            </div>
            <% if(typeof pageCount!='undefined'){
                    if(pageCount>1) { %>
            <div class="float-right">
                <ul class="pagination mb-1">
                    <%  
                        if(page>1){ %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=1&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">|&lt;</a></li>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(page-1)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&lt;</a></li>
                        <% }
                        var sayfalar=pagination(page,pageCount);
                        for(var i=0;i<sayfalar.length;i++){
                            if(sayfalar[i]==page){ %>
                            <li class="page-item active"><span class="page-link"><%=page%></span></li>
                            <% } else if(sayfalar[i]=='...') { %>
                            <li class="page-item"><span class="page-link">...</span></li>
                            <% } else { %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=sayfalar[i]%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>"><%=sayfalar[i]%></a></li>
                            <% } %>
                        <% } %>
                        
                        <% if(page<pageCount) { %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(page+1)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&gt;</a></li>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(pageCount)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&gt;|</a></li>
                        <% } %>
                    
                </ul>
                
            </div>
            <% }
                } %>
        </div>
    </div>
    <table id="grid1" class="table table-bordered table-striped m-0"  cellspacing="0">
            <thead>
                <tr class="text-nowrap">
                    <% if(selection) { %>
                    <th style="width: 30px;"><input type="checkbox" value="true" name="selectAll" id="selectAll"></th>
                    <% } %>

                    <% fields.forEach(function(field){%> 
                        <th class="" style="<% if(typeof field.width!='undefined'){%>width:<%=field.width%><%}%>"><% if(field.icon!=''){%><i class="fa fa-<%=field.icon%>"></i> <% } %><%=field.text%></th>
                    <%});%>
                    <th class="text-center" style="width: <%=(ctrlCol*30)%>px;">
                         <% if(addNewButton){ %>
                            <a href="javascript:addNewUrl('<% if(typeof addNewUrl!='undefined'){%><%=addNewUrl%><%}else{%><%=urlPath%>/addnew?db=<%=db%>&sid=<%=sid%><%}%>');" class="btn btn-primary  btn-sm far fa-plus-square"  title="Yeni Ekle"></a>
                        <% } else {%>
                        #
                        <% } %>
                    </th>
                </tr>
                <% if(showFilterRow){ %>
                <tr class="collapse" id="filterRow">
                    <% if(selection) { %>
                    <th class=""></th>
                    <% } %>
                    
                    <% fields.forEach(function(field,index){%> 
                        <!-- <th class="<% if(typeof field.width!='undefined'){%>ctrl-col-<%=field.width%><%}%> nowrap"> -->
                        <th class="" style="">
                            <% if(field.filter){ %>
                                <% if(field.type=='lookup' && typeof field.lookupList!='undefined'){ %>
                                    <select name="filter_<%=index%>" id="filter_<%=index%>" class="form-control p-0 m-0">
                                        <% field.lookupList.forEach(function(lookupItem){ %> 
                                            <option value="<%=lookupItem[field.valueField]%>" <% if(field.filterValue==lookupItem[field.valueField]){%>selected<% } %> ><%=lookupItem[field.textField]%></option>
                                        <% }); %>
                                    </select>
                                <% } else { %>
                                    <input type="text" class="form-control p-0 m-0" name="filter_<%=index%>" id="filter_<%=index%>" <% if(typeof field.placeholder!='undefined'){%>placeholder="<%=field.placeholder%>"<%}%> value="<%=field.filterValue%>">
                                <% } %>
                            <% } %>
                        </th>
                    <%});%>

                    <th>
                        
                    </th>
                </tr>
                <% } %>
            </thead>
            <tbody>
                <% 
                    
                    
                    
                    list.forEach((item,index)=>{ %>
                    <tr>
                        <% if(selection && typeof item._id!='undefined') { %>
                        <td><input type="checkbox" class="checkSingle" value="<%- encodeURIComponent(JSON.stringify(item))%>" name="selected[<%=index%>]"  id="selected[<%=index%>]"></td>
                        <% } %>
                        <% fields.forEach((field)=>{
                            var itemValue;
                            if(typeof item!='undefined'){
                                itemValue=getPropertyByKeyPath(item,field);
                            }
                            
                            if(typeof itemValue=='undefined'){
                                itemValue='';
                            }
                        %>
                        <% if(typeof field.type!='undefined'){
                                if(field.type=='lookup' && typeof field.lookupList!='undefined' && field.dontUseLookup==false ){
                                    var bFound=false;
                                    
                                    field.lookupList.forEach(function(e){
                                        if(e[field.valueField]==itemValue){
                                            %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}%>"><%=e[field.textField]%></td><%
                                            bFound=true;
                                            return;
                                        }
                                    });
                                    if(bFound==false){
                                        %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}%>"><%=itemValue%></td><%
                                    }
                                }else if(field.type=='checkbox'){
                                    %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}else{%>text-center"<%}%>><% if(itemValue){%>evet<%}else{%>hayır<%}%></td><%
                                }else if(field.type=='button'){
                                    %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}else{%>text-center"<%}%>><a href="<%=field.path%>/<%=item._id%>?db=<%=db%>&sid=<%=sid%>" class="btn btn-info" title="<%=field.text%>" <% if(typeof field.buttonTarget!='undefined'){%>target="<%=field.buttonTarget%>"<%}%>><% if(field.icon!=''){%><i class="fa fa-<%=field.icon%>"></i> <% } %></a></td><%
                                }else{
                                    %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}%>"><%- mrutil.formatCol(itemValue,field) %></td><%
                                }
                            }else{
                            %><td class="<% if(typeof field.class!='undefined'){%><%=field.class%><%}%>"><%- mrutil.formatCol(itemValue,field)%></td>
                            <%} %>
                        
                        <%}); %>
                        <td class="text-nowrap">
                            <div style="display: inline-flex;">
                            <% 
                            if(typeof customButtons!='undefined') { 
                                if(customButtons.length>1){
                            %>
                            <div class="dropdown ml-1">

                                <button class="btn btn-secondary btn-sm fas fa-caret-square-down" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Diğer işlemler"></button>
                                <div class="dropdown-menu">
                                <% 
                                    for(var i=0;i<customButtons.length;i++){ 
                                    var target='_self';
                                    var href='';

                                    if(typeof customButtons[i].href!='undefined'){
                                        
                                        href=replaceUrlCurlyBracket(customButtons[i].href, item, fields);
                                    }
                                    if(typeof customButtons[i].target!='undefined') target=customButtons[i].target;
                                    
                                %>
                                    <a class="dropdown-item" href="<%=href%>" title="<%=customButtons[i].title%>" target="<%=target%>"><% if(customButtons[i].icon!=''){%><i class="<%=customButtons[i].icon%>"></i> <%}%><%=customButtons[i].text%></a>
                                    <% if(typeof customButtons[i].divider!='undefined'){
                                        if(customButtons[i].divider==true){ %>
                                    <div class="dropdown-divider my-1"></div>
                                        <% } %>
                                    <% } %>
                                

                                    <% } %>
                                </div>
                            </div>
                                <% }else if(customButtons.length==1){ 
                                    var target='_self';
                                    var href='';
                                    if(typeof customButtons[0].href!='undefined'){
                                        href=replaceUrlCurlyBracket(customButtons[0].href, item, fields);
                                    } 
                                    if(typeof customButtons[0].target!='undefined') target=customButtons[0].target;
                                    if(customButtons[0].title=='') customButtons[0].title=customButtons[0].text;
                                    %> 
                                    <a class="btn btn-secondary btn-sm ml-1" href="<%=href%>" title="<%=customButtons[0].title%>" target="<%=target%>"><% if(customButtons[0].icon!=''){%><i class="<%=customButtons[0].icon%>"></i><% }else{ %><i class="fas fa-chess-board"></i><% } %><% if(customButtons[0].text!=''){%> <%=customButtons[0].text%><%}%></a>
                                <% } %>
                            <% } %>
                            <% 
                            if(typeof printButton!='undefined'){ 
                               if(typeof printButton.path!='undefined'){ 
                                if(typeof printButton.printDesignList=='undefined') printButton.printDesignList=[];
                                var printAPIPath='/general/print?path=' + printButton.path + '&db=' + db + '&sid=' + sid;
                                
                                printAPIPath=replaceUrlCurlyBracket(printAPIPath,item,fields);
                                
                            %>
                            <% if(printButton.printDesignList.length<=1){ %>
                            <a href="javascript:popupCenter('<%=printAPIPath%>','Yazdır','900','600');" class="btn invoice-satis btn-sm ml-1" title="Yazdır"><i class="fas fa-print"></i></a>
                            <% } else { %>
                            <div class="dropdown ml-1">
                                <!-- <button class="btn btn-secondary btn-sm fas fa-caret-square-down" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Yazdır"></button> -->
                                <button class="btn  btn-sm invoice-satis" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false" title="Yazdır"><i class="fas fa-print"></i></button>
                                <div class="dropdown-menu">
                                    <% 
                                        console.log(printButton.printDesignList);
                                        printButton.printDesignList.forEach((e)=>{ 
                                        var printAPIPathWithId=printAPIPath + '&designId=' + e._id;
                                    %>
                                    <a class="dropdown-item" href="javascript:popupCenter('<%=printAPIPathWithId%>','Yazdır','900','600');" title="Yazdır" ><%=e.name%></a>
                                    <% }) %>
                                </div>
                            </div>                                    
                            <% } %>
                            <% }} %>
                            <% 
                               if(viewButton){ 
                                var viewUrlRow=urlPath + '/view/{_id}?db=' + db + '&sid=' + sid;
                                if(typeof viewUrl!='undefined') viewUrlRow=viewUrl;
                                viewUrlRow=replaceUrlCurlyBracket(viewUrlRow,item,fields);
                                

                            %>
                            <a href="javascript:popupCenter('<%=viewUrlRow%>','İncele','900','600');" class="btn btn-info  btn-sm fa fa-eye ml-1" title="İncele"></a>
                            <% } %>
                            <% if(editButton){ %>
                            <a href="javascript:openUrl('<% if(typeof editUrl!='undefined'){%><%=editUrl%><%}else{%><%=urlPath%>/edit/{_id}?db=<%=db%>&sid=<%=sid%><%}%>','<%=item._id%>');" class="btn btn-primary  btn-sm fas fa-edit ml-1"  title="Düzenle"></a>
                            <% } %>
                            <% if(deleteButton && typeof deleteUrl!='undefined'){ %>
                            <a href="javascript:deleteItem('<%=deleteUrl%>','<%=item._id%>');"  class="btn btn-danger btn-sm fas fa-trash-alt ml-1" title="Sil"></a>
                            <% } %>
                            </div>
                        </td>
                    </tr>
                <% }); %>
            </tbody>
    </table>
    <div class="row m-0 border rounded pt-2">
        <div class="col-12">
            <div class="float-left form-inline p-0 mt-1 mb-1 mr-4">
                <div class="" style="display: inline-block;">
                    <button class="btn btn-success btn-sm" id="btnExportExcel" title="Excel Export"><i class="fas fa-file-excel"></i></button>
                    <button class="btn btn-success btn-sm" id="btnExportCsv" title="Csv Export"><i class="fas fa-file-csv"></i></button>
                </div>
            </div>
            <div class="float-left form-inline m-0 p-0 mt-2 mb-1">
                <div class="" style="display: inline-block;">
                    <% if(typeof pageSize!='undefined'){ %>
                        <%=((page-1)*pageSize)+1%> - <% if(page*pageSize<recordCount) {%><%=page*pageSize%><%} else {%><%=recordCount%><%} %> arasi, Toplam: <%=recordCount%> kayit, <%=pageCount%> sayfa
                    <% } else if(typeof recordCount!='undefined'){ %>
                        Toplam: <%=recordCount%> kayit
                    <% } %>
                </div>
            </div>
            <% if(typeof pageCount!='undefined'){
                    if(pageCount>1) { %>
            <div class="float-right">
                <ul class="pagination mb-1">
                    <%  
                        if(page>1){ %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=1&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">|&lt;</a></li>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(page-1)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&lt;</a></li>
                        <% }
                        var sayfalar=pagination(page,pageCount);
                        for(var i=0;i<sayfalar.length;i++){
                            if(sayfalar[i]==page){ %>
                            <li class="page-item active"><span class="page-link"><%=page%></span></li>
                            <% } else if(sayfalar[i]=='...') { %>
                            <li class="page-item"><span class="page-link">...</span></li>
                            <% } else { %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=sayfalar[i]%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>"><%=sayfalar[i]%></a></li>
                            <% } %>
                        <% } %>
                        
                        <% if(page<pageCount) { %>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(page+1)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&gt;</a></li>
                            <li class="page-item"><a class="page-link" href="<%=urlPath%>?page=<%=(pageCount)%>&<%=filterString%>&db=<%=db%>&sid=<%=sid%>">&gt;|</a></li>
                        <% } %>
                </ul>
            </div>
            <% }
                } %>
        </div>
    </div>
</div>

<script type="text/javascript">
    
    

    $(document).ready(function(){
        $("#btnExportExcel").click(function () {
            fnExcelReport('grid1','<%=title%>');
        });
        $("#btnExportCsv").click(function () {
            fnCsvReport('grid1','<%=title%>');
        });
        $('#pageSize').change(function(e){
            savePageFilter('<%=urlPath%>','pageSize',$('#pageSize').val());
            var filterUrl='<% for(let k in filterObjects){%><%=k%>=<%=filterObjects[k]%>&<%}%>';
            window.location.href='<%=urlPath%>?page=1&pageSize=' + $('#pageSize').val() + '&' + filterUrl + 'db=<%=db%>&sid=<%=sid%>';
        });

        <% if(selection){ %>
            $('#selectAll').change(function(e){
                
                $('input:checkbox').not(this).prop('checked', this.checked);
            });
        <% } %>

        <% if(showFilterRow) { 

            fields.forEach(function(field,index){
                if(field.filter){
            %>
                <% if(field.type=='lookup'){ %>
                    $("#filter_<%=index%>").change(function(e){
                        
                        keyupTimer=0;
                        runFilter();
                    });
                <% } else { %>
                    $("#filter_<%=index%>").keyup(function(e){
                        setTimeout(function(){
                            keyupTimer=1;
                            runTimer(); 
                        },500);
                    });
                <% } %>
            <% } }); %>

            var keyupTimer=0;

            function runTimer(){
                if(keyupTimer==0) return;
                
                if(keyupTimer>=3){
                    keyupTimer=0;
                    runFilter();
                }else{
                    keyupTimer++;
                    setTimeout(runTimer,1000);
                }
            }
            function runFilter(){
                var params=getAllUrlParams();
                var filtreVar=false;
                <% 
                    
                    
                    fields.forEach(function(field,index){
                    if(field.filter){
                        
                        //return;
                %>
                    filtreVar=true;
                    if($("#filter_<%=index%>").val()!=''){
                        params['<%=field.filterField%>']=$("#filter_<%=index%>").val();
                        //queryString=queryString + '&<%=field.filterField%>=' + encodeURIComponent($("#filter_<%=index%>").val());
                    }else{
                        if(params['<%=field.filterField%>']!=undefined){
                            params['<%=field.filterField%>']=undefined;
                            delete params['<%=field.filterField%>'];
                        }
                    }

                <% } }); %>
                if(filtreVar){
                    var queryString='';
                    for(let key in params){
                        if(queryString!='') queryString +='&';
                        queryString +=key + '=' + encodeURIComponent(params[key]);
                    }
                    window.location.search=queryString;
                    //window.location.reload();
                }
            }
            if(localStorage.getItem('grid-filterBtn<%- urlPath %>')=='true'){
                $('#filterRow').collapse({toggle:true});
            }else{
                $('#filterRow').collapse({toggle:false});
            }

            $('#filterRow').on('hidden.bs.collapse', function () {
                localStorage.setItem('grid-filterBtn<%- urlPath %>',false);
            })
            $('#filterRow').on('shown.bs.collapse', function () {
                localStorage.setItem('grid-filterBtn<%- urlPath %>',true);
            })

        <% } %>
       
    });
   

    function addNewUrl(url){
        localStorage.setItem('returnUrl',window.location.href);
        //url=url.replaceAll('{_id}',_id);
        window.location.href=url;
    }

        
    

    function deleteItem(url,_id){
        
        if(url==''){
            alert('deleteItem deleteUrl gerekli');
            return;
        }
        if(!confirm("Kayit silinecektir! Onayliyor musunuz?")) return;

        url=url.replaceAll('{_id}',_id);
        $.ajax({
            url:url,
            type:'DELETE',
            success:function(result){
            	console.log(`result:`,result)
            	console.log(`type of result:`,typeof result)
                if(result.success){
                    window.location.reload();
                }else{

                    alert('Hata:' + result.error.message);
                }
            },
            error:function(err){
            	console.log(`error:`,err)
            	alert(err)
            }
        });
        // localStorage.setItem('returnUrl',window.location.href);
        // window.location.href=url;
    }
   

</script>

<%

function getPropertyByKeyPath(targetObj, field) { 
        var keyPath=field.name;
        var keys = keyPath.split('.');
        if(keys.length == 0) return undefined; 
        keys = keys.reverse();
        var subObject = targetObj;
        while(keys.length) {
           var k = keys.pop();
           if(typeof subObject[k]=='undefined' || subObject[k]==null) {
            return undefined;
           } else {
            subObject = subObject[k];
           }
        }
        return subObject;
    }

    function replaceUrlCurlyBracket(url,item,fields){
        
        if(!(url.indexOf('{')>-1 && url.indexOf('}')>-1))  return url;
        if(typeof item!='undefined')
            if(typeof item._id!='undefined'){
                url=url.replaceAll('{_id}',item._id);
            }
        fields.forEach((field)=>{

            if(!(url.indexOf('{')>-1 && url.indexOf('}')>-1)){
                
                return;
            }
            var itemValue;
            if(typeof item!='undefined'){
                itemValue=getPropertyByKeyPath(item,field);
            }
            
            if(typeof itemValue=='undefined'){
                itemValue='';
            }
            
            if(url.indexOf('{' + field.name + '}')>-1){
                url=url.replaceAll('{' + field.name + '}',itemValue);
            }
        })

        return url;
    }



function pagination(c, m) {
    var current =Number(c),
        last = Number(m),
        delta = 2,
        left = current - delta,
        right = current + delta + 1,
        range = [],
        rangeWithDots = [],
        l;
    
    for (let i = 1; i <= last; i++) {
        if (i == 1 || i == last || i >= left && i < right) {
            range.push(i);
        }
    }


    for (let i of range) {
        if (l) {
            if (i - l == 2) {
                rangeWithDots.push(l + 1);
            } else if (i - l != 1) {
                rangeWithDots.push('...');
            }
        }
        rangeWithDots.push(i);
        
        
        l = i;
    }

    return rangeWithDots;
}


%>